<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>
        Sistema de Control de Unidades
    </title>
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js">
    </script>
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-header: #1d4ed8;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-header: #0f172a;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Actualizar estilos para usar variables */
        .bg-white {
            background-color: var(--bg-secondary) !important;
        }

        .text-gray-800 {
            color: var(--text-primary) !important;
        }

        .text-gray-700 {
            color: var(--text-secondary) !important;
        }

        .border-gray-200 {
            border-color: var(--border-color) !important;
        }

        .border-gray-300 {
            border-color: var(--border-color) !important;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px var(--shadow), 0 4px 6px -4px var(--shadow) !important;
        }

        /* Estilos para inputs y formularios en modo oscuro */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            border-color: #3b82f6;
            background-color: #4b5563;
        }

        /* Estilos para tablas en modo oscuro */
        [data-theme="dark"] table {
            background-color: var(--bg-secondary);
        }

        [data-theme="dark"] th {
            background-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] td {
            border-color: var(--border-color);
        }

        [data-theme="dark"] tr:nth-child(even) {
            background-color: #374151;
        }

        /* Actualizar header para tema oscuro */
        [data-theme="dark"] header {
            background-color: var(--bg-header) !important;
        }

        /* Badges y estados en modo oscuro */
        [data-theme="dark"] .badge-completo {
            background-color: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .badge-incompleto {
            background-color: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .badge-sin-registro {
            background-color: #4b5563;
            color: #d1d5db;
        }

        /* Botones en modo oscuro */
        [data-theme="dark"] .bg-blue-600 {
            background-color: #1e40af !important;
        }

        [data-theme="dark"] .bg-green-600 {
            background-color: #059669 !important;
        }

        [data-theme="dark"] .bg-red-600 {
            background-color: #dc2626 !important;
        }

        [data-theme="dark"] .bg-gray-500 {
            background-color: #6b7280 !important;
        }

        /* Hover states para botones en modo oscuro */
        [data-theme="dark"] .hover\:bg-blue-700:hover {
            background-color: #1d4ed8 !important;
        }

        [data-theme="dark"] .hover\:bg-green-700:hover {
            background-color: #047857 !important;
        }

        [data-theme="dark"] .hover\:bg-red-700:hover {
            background-color: #b91c1c !important;
        }

        [data-theme="dark"] .hover\:bg-gray-600:hover {
            background-color: #4b5563 !important;
        }

        /* Gradiente de fondo en modo oscuro */
        [data-theme="dark"] #main-container {
            background: linear-gradient(to bottom right, #0f172a, #1e293b) !important;
        }

        /* Estilos específicos para el panel de resumen en modo oscuro */
        [data-theme="dark"] .bg-gray-100 {
            background-color: #374151 !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .bg-gray-100 p {
            color: #ffffff !important;
        }

        [data-theme="dark"] .bg-gray-100 span {
            color: #ffffff !important;
        }

        [data-theme="dark"] .bg-gray-100 .font-semibold {
            color: #ffffff !important;
        }

        /* Resumen específico en control panel */
        [data-theme="dark"] div[class*="bg-gray-100"] {
            background-color: #374151 !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] div[class*="bg-gray-100"] * {
            color: #ffffff !important;
        }

        /* Selector super específico para el div de resumen */
        [data-theme="dark"] .p-3.bg-gray-100.rounded-lg {
            background-color: #374151 !important;
            border: 1px solid #4b5563 !important;
        }

        [data-theme="dark"] .p-3.bg-gray-100.rounded-lg p,
        [data-theme="dark"] .p-3.bg-gray-100.rounded-lg span,
        [data-theme="dark"] .p-3.bg-gray-100.rounded-lg label {
            color: #ffffff !important;
        }

        /* Estilos ultra específicos para el panel de control */
        [data-theme="dark"] #content-control .bg-gray-100 {
            background-color: #374151 !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] #content-control .bg-gray-100 * {
            color: #ffffff !important;
        }

        /* Forzar estilos para cualquier elemento bg-gray-100 en tema oscuro */
        [data-theme="dark"] *[class*="bg-gray-100"] {
            background-color: #374151 !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] *[class*="bg-gray-100"] * {
            color: #ffffff !important;
        }

        /* Estilos para operadores seleccionados en tema oscuro */
        [data-theme="dark"] .bg-blue-50 {
            background-color: #1e3a8a !important;
            border-color: #3b82f6 !important;
        }

        [data-theme="dark"] .border-blue-200 {
            border-color: #3b82f6 !important;
        }

        [data-theme="dark"] .bg-blue-50 span {
            color: #ffffff !important;
        }

        [data-theme="dark"] .bg-blue-50 button {
            color: #d1d5db !important;
        }

        [data-theme="dark"] .bg-blue-50 button:hover {
            color: #ef4444 !important;
        }

        /* Selectores muy específicos para el resumen */
        body[data-theme="dark"] .bg-gray-100 {
            background-color: #374151 !important;
            color: #ffffff !important;
            border: 1px solid #4b5563 !important;
        }

        body[data-theme="dark"] .bg-gray-100 p {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .bg-gray-100 span {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .bg-gray-100 label {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .bg-gray-100 .font-semibold {
            color: #ffffff !important;
        }

        /* Override para Tailwind específico */
        body[data-theme="dark"] .p-3.bg-gray-100.rounded-lg {
            background: #374151 !important;
            color: white !important;
        }

        body[data-theme="dark"] .p-3.bg-gray-100.rounded-lg > * {
            color: white !important;
        }

        [data-theme="dark"] .text-gray-700 {
            color: #d1d5db !important;
        }

        [data-theme="dark"] .text-gray-500 {
            color: #9ca3af !important;
        }

        /* Estilos para labels en modo oscuro */
        [data-theme="dark"] label {
            color: #d1d5db !important;
        }

        /* Checkboxes en modo oscuro */
        [data-theme="dark"] input[type="checkbox"] {
            background-color: #374151;
            border-color: #4b5563;
        }

        [data-theme="dark"] input[type="checkbox"]:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        /* Cards y elementos de resumen en modo oscuro */
        [data-theme="dark"] .bg-white {
            background-color: #1f2937 !important;
        }

        [data-theme="dark"] .border-gray-200 {
            border-color: #374151 !important;
        }

        [data-theme="dark"] .text-black {
            color: #f3f4f6 !important;
        }

        /* Elementos específicos del panel de control */
        [data-theme="dark"] .control-panel .bg-gray-100 {
            background-color: #374151 !important;
            border: 1px solid #4b5563;
        }

        [data-theme="dark"] .control-panel h3 {
            color: #f3f4f6 !important;
        }

        .tab-active {
            background-color: #3b82f6;
            color: white;
        }

        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .chofer-item:hover {
            background-color: #e5edff;
        }

        .chofer-item.selected {
            background-color: #dbeafe;
        }

        .badge-incompleto {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .badge-completo {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .badge-sin-registro {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #9ca3af;
        }

        .alerta-incompleto {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            transform: translateY(-1px);
        }

        .btn-edit {
            background-color: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background-color: #2563eb;
        }

        .btn-delete {
            background-color: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background-color: #dc2626;
        }

        .btn-add {
            background-color: #10b981;
            color: white;
        }

        .btn-add:hover {
            background-color: #059669;
        }

        /* Estilos responsivos */
        .mobile-menu-button {
            display: none;
        }

        .mobile-menu {
            display: none;
        }

        .hamburger-icon {
            transition: transform 0.2s ease-in-out;
        }

        .hamburger-icon.active {
            transform: rotate(90deg);
        }

        @media (max-width: 768px) {
            .mobile-menu-button {
                display: block !important;
            }

            .desktop-menu {
                display: none !important;
            }

            /* Forzar ocultamiento del menú desktop */
            div.desktop-menu.flex.mb-6.border-b.border-gray-200 {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            .mobile-menu {
                display: block;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: white;
                border-top: 1px solid #e5e7eb;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 50;
            }

            .mobile-menu.hidden {
                display: none;
            }

            .mobile-menu button {
                display: block;
                width: 100%;
                text-align: left;
                padding: 12px 16px;
                border-bottom: 1px solid #e5e7eb;
                background-color: white;
                color: #374151;
                font-weight: 500;
                transition: background-color 0.2s;
            }

            .mobile-menu button:hover {
                background-color: #f3f4f6;
            }

            .mobile-menu button.tab-active {
                background-color: #3b82f6;
                color: white;
            }

            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Hacer las tablas horizontalmente scrollables en móvil */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-container table {
                min-width: 600px;
            }

            /* Ajustar formularios en móvil */
            .flex.flex-wrap.gap-4 {
                flex-direction: column;
                gap: 1rem;
            }

            .flex.flex-wrap.gap-4 > div {
                flex: 1;
                min-width: 100%;
            }

            /* Ajustar grid en móvil */
            .grid.grid-cols-1.md\\:grid-cols-2.gap-6 {
                grid-template-columns: 1fr;
            }

            /* Ajustar padding en móvil */
            .p-6 {
                padding: 1rem;
            }

            .px-6 {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Hacer botones más grandes en móvil */
            button {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* Hacer inputs más grandes en móvil */
            input, select, textarea {
                min-height: 44px;
                font-size: 16px; /* Previene zoom en iOS */
            }

            /* Ajustar texto en móvil */
            .text-2xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.25rem;
            }

            /* Mejorar botones pequeños en móvil */
            .btn-icon {
                min-width: 44px;
                min-height: 44px;
            }

            /* Hacer responsivos los botones de acción */
            .flex.justify-end.space-x-4 {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .flex.justify-end.space-x-4 button {
                width: 100%;
                margin-left: 0;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                text-align: center;
            }

            /* Hacer responsivos otros grupos de botones */
            .flex.space-x-2 {
                flex-direction: column;
                gap: 0.5rem;
            }

            .flex.space-x-2 button {
                width: 100%;
                margin-left: 0;
            }

            /* Hacer responsivos los botones de exportar */
            .flex.space-x-2.mb-4 {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .flex.space-x-2.mb-4 button {
                flex: 1;
                min-width: calc(50% - 0.25rem);
            }

            /* Asegurar que el menú desktop esté completamente oculto */
            .desktop-menu,
            div[class*="desktop-menu"] {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .p-6 {
                padding: 0.75rem;
            }

            .text-2xl {
                font-size: 1.25rem;
            }

            .flex.gap-4 {
                gap: 0.5rem;
            }

            /* Botones más compactos en pantallas muy pequeñas */
            .flex.justify-end.space-x-4 button {
                padding: 0.625rem 0.75rem;
                font-size: 0.8rem;
            }

            /* Hacer formularios de una sola columna */
            .grid.grid-cols-1.md\\:grid-cols-2.gap-6 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* En pantallas muy pequeñas, hacer todos los botones apilados */
            .flex.space-x-2.mb-4 {
                flex-direction: column;
            }

            .flex.space-x-2.mb-4 button {
                width: 100%;
                min-width: auto;
            }
        }

        /* Estilos para el placeholder del contenteditable */
        #chat-input[contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #9CA3AF;
            pointer-events: none;
        }

        #chat-input:focus:before {
            content: none;
        }
    </style>
    <style>
        *,
        ::before,
        ::after {
            --tw-border-spacing-x: 0;
            --tw-border-spacing-y: 0;
            --tw-translate-x: 0;
            --tw-translate-y: 0;
            --tw-rotate: 0;
            --tw-skew-x: 0;
            --tw-skew-y: 0;
            --tw-scale-x: 1;
            --tw-scale-y: 1;
            --tw-pan-x: ;
            --tw-pan-y: ;
            --tw-pinch-zoom: ;
            --tw-scroll-snap-strictness: proximity;
            --tw-gradient-from-position: ;
            --tw-gradient-via-position: ;
            --tw-gradient-to-position: ;
            --tw-ordinal: ;
            --tw-slashed-zero: ;
            --tw-numeric-figure: ;
            --tw-numeric-spacing: ;
            --tw-numeric-fraction: ;
            --tw-ring-inset: ;
            --tw-ring-offset-width: 0px;
            --tw-ring-offset-color: #fff;
            --tw-ring-color: rgb(59 130 246 / 0.5);
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 #0000;
            --tw-shadow: 0 0 #0000;
            --tw-shadow-colored: 0 0 #0000;
            --tw-blur: ;
            --tw-brightness: ;
            --tw-contrast: ;
            --tw-grayscale: ;
            --tw-hue-rotate: ;
            --tw-invert: ;
            --tw-saturate: ;
            --tw-sepia: ;
            --tw-drop-shadow: ;
            --tw-backdrop-blur: ;
            --tw-backdrop-brightness: ;
            --tw-backdrop-contrast: ;
            --tw-backdrop-grayscale: ;
            --tw-backdrop-hue-rotate: ;
            --tw-backdrop-invert: ;
            --tw-backdrop-opacity: ;
            --tw-backdrop-saturate: ;
            --tw-backdrop-sepia: ;
            --tw-contain-size: ;
            --tw-contain-layout: ;
            --tw-contain-paint: ;
            --tw-contain-style:
        }

        ::backdrop {
            --tw-border-spacing-x: 0;
            --tw-border-spacing-y: 0;
            --tw-translate-x: 0;
            --tw-translate-y: 0;
            --tw-rotate: 0;
            --tw-skew-x: 0;
            --tw-skew-y: 0;
            --tw-scale-x: 1;
            --tw-scale-y: 1;
            --tw-pan-x: ;
            --tw-pan-y: ;
            --tw-pinch-zoom: ;
            --tw-scroll-snap-strictness: proximity;
            --tw-gradient-from-position: ;
            --tw-gradient-via-position: ;
            --tw-gradient-to-position: ;
            --tw-ordinal: ;
            --tw-slashed-zero: ;
            --tw-numeric-figure: ;
            --tw-numeric-spacing: ;
            --tw-numeric-fraction: ;
            --tw-ring-inset: ;
            --tw-ring-offset-width: 0px;
            --tw-ring-offset-color: #fff;
            --tw-ring-color: rgb(59 130 246 / 0.5);
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 #0000;
            --tw-shadow: 0 0 #0000;
            --tw-shadow-colored: 0 0 #0000;
            --tw-blur: ;
            --tw-brightness: ;
            --tw-contrast: ;
            --tw-grayscale: ;
            --tw-hue-rotate: ;
            --tw-invert: ;
            --tw-saturate: ;
            --tw-sepia: ;
            --tw-drop-shadow: ;
            --tw-backdrop-blur: ;
            --tw-backdrop-brightness: ;
            --tw-backdrop-contrast: ;
            --tw-backdrop-grayscale: ;
            --tw-backdrop-hue-rotate: ;
            --tw-backdrop-invert: ;
            --tw-backdrop-opacity: ;
            --tw-backdrop-saturate: ;
            --tw-backdrop-sepia: ;
            --tw-contain-size: ;
            --tw-contain-layout: ;
            --tw-contain-paint: ;
            --tw-contain-style:
        }

        /* ! tailwindcss v3.4.16 | MIT License | https://tailwindcss.com */
        *,
        ::after,
        ::before {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb
        }

        ::after,
        ::before {
            --tw-content: ''
        }

        :host,
        html {
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -moz-tab-size: 4;
            tab-size: 4;
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            font-feature-settings: normal;
            font-variation-settings: normal;
            -webkit-tap-highlight-color: transparent
        }

        body {
            margin: 0;
            line-height: inherit
        }

        hr {
            height: 0;
            color: inherit;
            border-top-width: 1px
        }

        abbr:where([title]) {
            -webkit-text-decoration: underline dotted;
            text-decoration: underline dotted
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-size: inherit;
            font-weight: inherit
        }

        a {
            color: inherit;
            text-decoration: inherit
        }

        b,
        strong {
            font-weight: bolder
        }

        code,
        kbd,
        pre,
        samp {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-feature-settings: normal;
            font-variation-settings: normal;
            font-size: 1em
        }

        small {
            font-size: 80%
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative;
            vertical-align: baseline
        }

        sub {
            bottom: -.25em
        }

        sup {
            top: -.5em
        }

        table {
            text-indent: 0;
            border-color: inherit;
            border-collapse: collapse
        }

        button,
        input,
        optgroup,
        select,
        textarea {
            font-family: inherit;
            font-feature-settings: inherit;
            font-variation-settings: inherit;
            font-size: 100%;
            font-weight: inherit;
            line-height: inherit;
            letter-spacing: inherit;
            color: inherit;
            margin: 0;
            padding: 0
        }

        button,
        select {
            text-transform: none
        }

        button,
        input:where([type=button]),
        input:where([type=reset]),
        input:where([type=submit]) {
            -webkit-appearance: button;
            background-color: transparent;
            background-image: none
        }

        :-moz-focusring {
            outline: auto
        }

        :-moz-ui-invalid {
            box-shadow: none
        }

        progress {
            vertical-align: baseline
        }

        ::-webkit-inner-spin-button,
        ::-webkit-outer-spin-button {
            height: auto
        }

        [type=search] {
            -webkit-appearance: textfield;
            outline-offset: -2px
        }

        ::-webkit-search-decoration {
            -webkit-appearance: none
        }

        ::-webkit-file-upload-button {
            -webkit-appearance: button;
            font: inherit
        }

        summary {
            display: list-item
        }

        blockquote,
        dd,
        dl,
        figure,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        hr,
        p,
        pre {
            margin: 0
        }

        fieldset {
            margin: 0;
            padding: 0
        }

        legend {
            padding: 0
        }

        menu,
        ol,
        ul {
            list-style: none;
            margin: 0;
            padding: 0
        }

        dialog {
            padding: 0
        }

        textarea {
            resize: vertical
        }

        input::placeholder,
        textarea::placeholder {
            opacity: 1;
            color: #9ca3af
        }

        [role=button],
        button {
            cursor: pointer
        }

        :disabled {
            cursor: default
        }

        audio,
        canvas,
        embed,
        iframe,
        img,
        object,
        svg,
        video {
            display: block;
            vertical-align: middle
        }

        img,
        video {
            max-width: 100%;
            height: auto
        }

        [hidden]:where(:not([hidden=until-found])) {
            display: none
        }

        .container {
            width: 100%
        }

        @media (min-width: 640px) {
            .container {
                max-width: 640px
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 768px
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1024px
            }
        }

        @media (min-width: 1280px) {
            .container {
                max-width: 1280px
            }
        }

        @media (min-width: 1536px) {
            .container {
                max-width: 1536px
            }
        }

        .fixed {
            position: fixed
        }

        .absolute {
            position: absolute
        }

        .relative {
            position: relative
        }

        .sticky {
            position: sticky
        }

        .inset-0 {
            inset: 0px
        }

        .top-0 {
            top: 0px
        }

        .z-10 {
            z-index: 10
        }

        .z-50 {
            z-index: 50
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto
        }

        .mb-1 {
            margin-bottom: 0.25rem
        }

        .mb-2 {
            margin-bottom: 0.5rem
        }

        .mb-4 {
            margin-bottom: 1rem
        }

        .mb-6 {
            margin-bottom: 1.5rem
        }

        .ml-2 {
            margin-left: 0.5rem
        }

        .mr-2 {
            margin-right: 0.5rem
        }

        .mt-1 {
            margin-top: 0.25rem
        }

        .mt-2 {
            margin-top: 0.5rem
        }

        .mt-4 {
            margin-top: 1rem
        }

        .block {
            display: block
        }

        .flex {
            display: flex
        }

        .grid {
            display: grid
        }

        .hidden {
            display: none
        }

        .h-4 {
            height: 1rem
        }

        .max-h-60 {
            max-height: 15rem
        }

        .min-h-screen {
            min-height: 100vh
        }

        .w-4 {
            width: 1rem
        }

        .w-full {
            width: 100%
        }

        .min-w-full {
            min-width: 100%
        }

        .max-w-md {
            max-width: 28rem
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr))
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr))
        }

        .flex-wrap {
            flex-wrap: wrap
        }

        .items-center {
            align-items: center
        }

        .justify-end {
            justify-content: flex-end
        }

        .justify-center {
            justify-content: center
        }

        .justify-between {
            justify-content: space-between
        }

        .gap-4 {
            gap: 1rem
        }

        .gap-6 {
            gap: 1.5rem
        }

        .space-x-4> :not([hidden])~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(1rem * var(--tw-space-x-reverse));
            margin-left: calc(1rem * calc(1 - var(--tw-space-x-reverse)))
        }

        .space-y-4> :not([hidden])~ :not([hidden]) {
            --tw-space-y-reverse: 0;
            margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
            margin-bottom: calc(1rem * var(--tw-space-y-reverse))
        }

        .space-x-2> :not([hidden])~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(0.5rem * var(--tw-space-x-reverse));
            margin-left: calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))
        }

        .overflow-y-auto {
            overflow-y: auto
        }

        .rounded {
            border-radius: 0.25rem
        }

        .rounded-full {
            border-radius: 9999px
        }

        .rounded-lg {
            border-radius: 0.5rem
        }

        .rounded-t-lg {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem
        }

        .border {
            border-width: 1px
        }

        .border-b {
            border-bottom-width: 1px
        }

        .border-blue-200 {
            --tw-border-opacity: 1;
            border-color: rgb(191 219 254 / var(--tw-border-opacity, 1))
        }

        .border-gray-200 {
            --tw-border-opacity: 1;
            border-color: rgb(229 231 235 / var(--tw-border-opacity, 1))
        }

        .border-gray-300 {
            --tw-border-opacity: 1;
            border-color: rgb(209 213 219 / var(--tw-border-opacity, 1))
        }

        .bg-black {
            --tw-bg-opacity: 1;
            background-color: rgb(0 0 0 / var(--tw-bg-opacity, 1))
        }

        .bg-blue-50 {
            --tw-bg-opacity: 1;
            background-color: rgb(239 246 255 / var(--tw-bg-opacity, 1))
        }

        .bg-blue-600 {
            --tw-bg-opacity: 1;
            background-color: rgb(37 99 235 / var(--tw-bg-opacity, 1))
        }

        .bg-blue-700 {
            --tw-bg-opacity: 1;
            background-color: rgb(29 78 216 / var(--tw-bg-opacity, 1))
        }

        .bg-gray-100 {
            --tw-bg-opacity: 1;
            background-color: rgb(243 244 246 / var(--tw-bg-opacity, 1))
        }

        .bg-gray-500 {
            --tw-bg-opacity: 1;
            background-color: rgb(107 114 128 / var(--tw-bg-opacity, 1))
        }

        .bg-green-600 {
            --tw-bg-opacity: 1;
            background-color: rgb(22 163 74 / var(--tw-bg-opacity, 1))
        }

        .bg-red-600 {
            --tw-bg-opacity: 1;
            background-color: rgb(220 38 38 / var(--tw-bg-opacity, 1))
        }

        .bg-white {
            --tw-bg-opacity: 1;
            background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1))
        }

        .bg-opacity-50 {
            --tw-bg-opacity: 0.5
        }

        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--tw-gradient-stops))
        }

        .from-blue-50 {
            --tw-gradient-from: #eff6ff var(--tw-gradient-from-position);
            --tw-gradient-to: rgb(239 246 255 / 0) var(--tw-gradient-to-position);
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to)
        }

        .to-indigo-100 {
            --tw-gradient-to: #e0e7ff var(--tw-gradient-to-position)
        }

        .p-2 {
            padding: 0.5rem
        }

        .p-3 {
            padding: 0.75rem
        }

        .p-6 {
            padding: 1.5rem
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem
        }

        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem
        }

        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem
        }

        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem
        }

        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem
        }

        .py-6 {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem
        }

        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem
        }

        .text-left {
            text-align: left
        }

        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem
        }

        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem
        }

        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem
        }

        .font-bold {
            font-weight: 700
        }

        .font-medium {
            font-weight: 500
        }

        .font-semibold {
            font-weight: 600
        }

        .text-blue-600 {
            --tw-text-opacity: 1;
            color: rgb(37 99 235 / var(--tw-text-opacity, 1))
        }

        .text-gray-500 {
            --tw-text-opacity: 1;
            color: rgb(107 114 128 / var(--tw-text-opacity, 1))
        }

        .text-gray-600 {
            --tw-text-opacity: 1;
            color: rgb(75 85 99 / var(--tw-text-opacity, 1))
        }

        .text-gray-700 {
            --tw-text-opacity: 1;
            color: rgb(55 65 81 / var(--tw-text-opacity, 1))
        }

        .text-gray-800 {
            --tw-text-opacity: 1;
            color: rgb(31 41 55 / var(--tw-text-opacity, 1))
        }

        .text-white {
            --tw-text-opacity: 1;
            color: rgb(255 255 255 / var(--tw-text-opacity, 1))
        }

        .shadow-lg {
            --tw-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)
        }

        .transition {
            transition-property: color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms
        }

        .hover\:bg-blue-100:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(219 234 254 / var(--tw-bg-opacity, 1))
        }

        .hover\:bg-blue-700:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(29 78 216 / var(--tw-bg-opacity, 1))
        }

        .hover\:bg-gray-600:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(75 85 99 / var(--tw-bg-opacity, 1))
        }

        .hover\:bg-green-700:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(21 128 61 / var(--tw-bg-opacity, 1))
        }

        .hover\:bg-red-700:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(185 28 28 / var(--tw-bg-opacity, 1))
        }

        .hover\:text-red-500:hover {
            --tw-text-opacity: 1;
            color: rgb(239 68 68 / var(--tw-text-opacity, 1))
        }

        .focus\:outline-none:focus {
            outline: 2px solid transparent;
            outline-offset: 2px
        }

        .focus\:ring-2:focus {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)
        }

        .focus\:ring-blue-500:focus {
            --tw-ring-opacity: 1;
            --tw-ring-color: rgb(59 130 246 / var(--tw-ring-opacity, 1))
        }

        @media (min-width: 768px) {
            .md\:w-64 {
                width: 16rem
            }

            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr))
            }
        }
    </style>
</head>

<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 transition-colors duration-300" id="main-container">
        <header class="bg-blue-700 text-white shadow-lg relative">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold">
                        Sistema de Control de Unidades
                    </h1>
                    <div class="flex items-center gap-2">
                        <!-- Información de usuario -->
                        <div class="hidden md:flex items-center text-white mr-4">
                            <i class="fas fa-user mr-2"></i>
                            <span id="user-name">Usuario</span>
                        </div>
                        <!-- Botón de administración (solo para admins) -->
                        <button class="hidden text-white bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-sm font-medium transition-colors duration-200 mr-2" id="admin-btn" title="Panel de Administración">
                            <i class="fas fa-cog mr-1"></i>
                            <span class="hidden lg:inline">Admin</span>
                        </button>
                        <!-- Botón de logout -->
                        <button class="text-white hover:text-red-300 focus:outline-none transition-colors duration-200" id="logout-button" title="Cerrar sesión">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <!-- Botón de cambio de tema -->
                        <button class="text-white hover:text-yellow-300 focus:outline-none transition-colors duration-200" id="theme-toggle" title="Cambiar tema">
                            <svg class="w-6 h-6" id="theme-icon-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <svg class="w-6 h-6 hidden" id="theme-icon-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        <!-- Botón de menú hamburguesa para móvil -->
                        <button class="mobile-menu-button text-white focus:outline-none" id="mobile-menu-toggle">
                            <svg class="w-6 h-6 hamburger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Menú móvil -->
                <div class="mobile-menu hidden" id="mobile-menu">
                    <button class="tab-active" id="mobile-tab-control">
                        Control de Turnos
                    </button>
                    <button id="mobile-tab-unidades">
                        Tabla de Unidades
                    </button>
                    <button id="mobile-tab-choferes">
                        Gestión de Operadores
                    </button>
                    <button id="mobile-tab-reportes">
                        Reportes
                    </button>
                    <button id="mobile-tab-chat">
                        Chat
                    </button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-6">
            <!-- Navegación por pestañas (escritorio) -->
            <div class="desktop-menu flex mb-6 border-b border-gray-200">
                <button class="px-6 py-3 font-medium tab-active rounded-t-lg" id="tab-control">
                    Control de
                    Turnos
                </button>
                <button class="px-6 py-3 font-medium text-gray-700 hover:bg-blue-100 rounded-t-lg" id="tab-unidades">
                    Tabla de
                    Unidades
                </button>
                <button class="px-6 py-3 font-medium text-gray-700 hover:bg-blue-100 rounded-t-lg" id="tab-choferes">
                    Gestión de
                    Operadores
                </button>
                <button class="px-6 py-3 font-medium text-gray-700 hover:bg-blue-100 rounded-t-lg" id="tab-reportes">
                    Reportes
                </button>
                <button class="px-6 py-3 font-medium text-gray-700 hover:bg-blue-100 rounded-t-lg" id="tab-chat">
                    Chat
                </button>
            </div>
            <!-- Contenido de las pestañas -->
            <div class="tab-content" id="content-control">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Buscar Unidad
                    </h2>
                    <div class="flex flex-wrap gap-4">
                        <form class="w-full flex flex-wrap gap-4" id="form-buscar-unidad">
                            <div class="w-full md:w-64">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Número de Unidad
                                </label>
                                <input
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="search-unidad" placeholder="Número de unidad (1-200)" type="number" />
                            </div>
                            <div class="w-full md:w-64">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Fecha
                                </label>
                                <input
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="search-fecha" type="date" />
                            </div>
                            <div class="flex items-end">
                                <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    id="btn-buscar" type="submit">
                                    Buscar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden" id="unidad-details">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            Detalles de la Unidad
                            <span class="text-blue-600" id="unidad-numero">
                            </span>
                        </h2>
                        <div class="hidden px-3 py-1 text-sm font-medium rounded-full" id="estado-registro-badge">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="font-medium mb-2 text-gray-700">
                                Turno 1
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Operador
                                    </label>
                                    <div class="relative">
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            id="chofer1-search" placeholder="Buscar Operador..." type="text" />
                                        <input id="chofer1-id" type="hidden" />
                                        <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                                            id="chofer1-results">
                                        </div>
                                    </div>
                                    <div class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-200 hidden"
                                        id="chofer1-selected">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium" id="chofer1-nombre">
                                            </span>
                                            <button class="text-gray-500 hover:text-red-500" id="chofer1-clear"
                                                type="button">
                                                <i class="fas fa-times-circle">
                                                </i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Hora de Salida
                                    </label>
                                    <input
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        id="salida1" type="time" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Hora de Llegada
                                    </label>
                                    <input
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        id="llegada1" type="time" />
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-medium mb-2 text-gray-700">
                                Turno 2
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Operador
                                    </label>
                                    <div class="relative">
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            id="chofer2-search" placeholder="Buscar Operador..." type="text" />
                                        <input id="chofer2-id" type="hidden" />
                                        <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                                            id="chofer2-results">
                                        </div>
                                    </div>
                                    <div class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-200 hidden"
                                        id="chofer2-selected">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium" id="chofer2-nombre">
                                            </span>
                                            <button class="text-gray-500 hover:text-red-500" id="chofer2-clear"
                                                type="button">
                                                <i class="fas fa-times-circle">
                                                </i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Hora de Salida
                                    </label>
                                    <input
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        id="salida2" type="time" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Hora de Llegada
                                    </label>
                                    <input
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        id="llegada2" type="time" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-registro" type="date" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Resumen
                            </label>
                            <div class="p-3 bg-gray-100 rounded-lg">
                                <p>
                                    Turnos:
                                    <span class="font-semibold" id="total-turnos">
                                        0
                                    </span>
                                </p>
                                <p>
                                    Horas trabajadas:
                                    <span class="font-semibold" id="total-horas">
                                        0
                                    </span>
                                </p>
                                <div class="mt-2">
                                    <label class="flex items-center">
                                        <input class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                            id="marcar-incompleto" type="checkbox" />
                                        <span class="ml-2 text-sm text-gray-700">
                                            Marcar como reporte incompleto
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                            id="btn-cancelar">
                            Cancelar
                        </button>
                        <button class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                            id="btn-nuevo-registro">
                            Nuevo
                            Registro
                        </button>
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            id="btn-guardar">
                            Guardar
                            Registro
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6" id="registros-recientes">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Registros Recientes
                    </h2>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead class="sticky top-0 bg-white">
                                <tr class="bg-gray-100 text-gray-700">
                                    <th class="py-3 px-4 text-left">
                                        Fecha
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Unidad
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Estado
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Operador 1
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Salida 1
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Llegada 1
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Operador 2
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Salida 2
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Llegada 2
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Turnos
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Horas
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tabla-registros">
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        2025-06-30
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        3
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">
                                            Completo
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        07:00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        0
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        0.00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <div class="flex space-x-2">
                                            <button class="btn-icon btn-edit" onclick="editarRegistro(3)">
                                                <i class="fas fa-edit">
                                                </i>
                                            </button>
                                            <button class="btn-icon btn-delete" onclick="confirmarEliminarRegistro(3)">
                                                <i class="fas fa-trash-alt">
                                                </i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        2025-06-30
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        2
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">
                                            Completo
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        Pedro Ruvalcaba
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        17:00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        00:00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        1
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        7.00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <div class="flex space-x-2">
                                            <button class="btn-icon btn-edit" onclick="editarRegistro(2)">
                                                <i class="fas fa-edit">
                                                </i>
                                            </button>
                                            <button class="btn-icon btn-delete" onclick="confirmarEliminarRegistro(2)">
                                                <i class="fas fa-trash-alt">
                                                </i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        2025-06-30
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        1
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">
                                            Completo
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        Juan Perez
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        05:00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        -
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        0
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        0.00
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <div class="flex space-x-2">
                                            <button class="btn-icon btn-edit" onclick="editarRegistro(1)">
                                                <i class="fas fa-edit">
                                                </i>
                                            </button>
                                            <button class="btn-icon btn-delete" onclick="confirmarEliminarRegistro(1)">
                                                <i class="fas fa-trash-alt">
                                                </i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Nueva pestaña: Tabla de Unidades -->
            <div class="tab-content hidden" id="content-unidades">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Tabla General de Unidades
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-tabla-unidades" type="date" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Filtrar por
                            </label>
                            <select
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="filtro-unidades">
                                <option value="todas">
                                    Todas las unidades
                                </option>
                                <option value="con-registro">
                                    Con registro
                                </option>
                                <option value="sin-registro">
                                    Sin registro
                                </option>
                                <option value="incompletas">
                                    Reportes incompletos
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead class="sticky top-0 bg-white">
                                <tr class="bg-gray-100 text-gray-700">
                                    <th class="py-3 px-4 text-left">
                                        Unidad
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Estado
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Turnos
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Horas
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tabla-todas-unidades">
                                <!-- Las unidades se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="content-choferes">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Gestión de Operadores
                    </h2>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="w-full md:w-64">
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="nombre-chofer" placeholder="Nombre del Operador" type="text" />
                            <input type="hidden" id="id-chofer-edicion" />
                        </div>
                        <button class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                            id="btn-agregar-chofer" onclick="guardarChofer()">
                            <i class="fas fa-plus mr-2">
                            </i>
                            <span id="texto-boton-chofer">Agregar Operador</span>
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead class="sticky top-0 bg-white">
                                <tr class="bg-gray-100 text-gray-700">
                                    <th class="py-3 px-4 text-left">
                                        Nombre
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tabla-choferes">
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        1
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        Pedro Ruvalcaba
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <button class="btn-icon btn-delete" onclick="eliminarChofer(1)">
                                            <i class="fas fa-trash-alt">
                                            </i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        2
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        Alejandro Ruvalcaba
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <button class="btn-icon btn-delete" onclick="eliminarChofer(2)">
                                            <i class="fas fa-trash-alt">
                                            </i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3 px-4 border-b">
                                        3
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        Juan Perez
                                    </td>
                                    <td class="py-3 px-4 border-b">
                                        <button class="btn-icon btn-delete" onclick="eliminarChofer(3)">
                                            <i class="fas fa-trash-alt">
                                            </i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="content-reportes">
                <div class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg" id="consultor-notice">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <p class="text-sm">Modo consultor activo: solo tienes acceso de lectura a los reportes.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex space-x-2 mb-4" id="exportar-diario">
                            <button
                                class="bg-red-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                                id="btn-descargar-reporte-diario-pdf">
                                <i class="fas fa-file-pdf">
                                </i>
                                PDF
                            </button>
                            <button
                                class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                                id="btn-descargar-reporte-diario-csv">
                                <i class="fas fa-file-csv">
                                </i>
                                CSV
                            </button>
                        </div>
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">
                            Reporte Diario
                        </h2>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-reporte-diario" type="date" />
                        </div>
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            id="btn-generar-reporte-diario">
                            Generar
                            Reporte
                        </button>
                        <div class="mt-4 hidden" id="reporte-diario-resultados">
                            <h3 class="font-medium mb-2 text-gray-700">
                                Resultados
                            </h3>
                            <div class="table-container">
                                <table class="min-w-full bg-white">
                                    <thead class="sticky top-0 bg-white">
                                        <tr class="bg-gray-100 text-gray-700">
                                            <th class="py-3 px-4 text-left">
                                                Unidad
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Estado
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Chofer
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Turnos
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Horas
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-reporte-diario">
                                        <!-- Los datos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex space-x-2 mb-4" id="exportar-mensual">
                            <button
                                class="bg-red-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                                id="btn-descargar-reporte-mensual-pdf">
                                <i class="fas fa-file-pdf">
                                </i>
                                PDF
                            </button>
                            <button
                                class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                                id="btn-descargar-reporte-mensual-csv">
                                <i class="fas fa-file-csv">
                                </i>
                                CSV
                            </button>
                        </div>
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">
                            Reporte Mensual
                        </h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Mes
                                </label>
                                <select
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="mes-reporte">
                                    <option value="1">
                                        Enero
                                    </option>
                                    <option value="2">
                                        Febrero
                                    </option>
                                    <option value="3">
                                        Marzo
                                    </option>
                                    <option value="4">
                                        Abril
                                    </option>
                                    <option value="5">
                                        Mayo
                                    </option>
                                    <option value="6">
                                        Junio
                                    </option>
                                    <option value="7">
                                        Julio
                                    </option>
                                    <option value="8">
                                        Agosto
                                    </option>
                                    <option value="9">
                                        Septiembre
                                    </option>
                                    <option value="10">
                                        Octubre
                                    </option>
                                    <option value="11">
                                        Noviembre
                                    </option>
                                    <option value="12">
                                        Diciembre
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Año
                                </label>
                                <input
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="anio-reporte" type="number" />
                            </div>
                        </div>
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            id="btn-generar-reporte-mensual">
                            Generar
                            Reporte
                        </button>
                        <div class="mt-4 hidden" id="reporte-mensual-resultados">
                            <h3 class="font-medium mb-2 text-gray-700">
                                Resultados
                            </h3>
                            <div class="table-container">
                                <table class="min-w-full bg-white">
                                    <thead class="sticky top-0 bg-white">
                                        <tr class="bg-gray-100 text-gray-700">
                                            <th class="py-3 px-4 text-left">
                                                Unidad
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Estado
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Total Turnos
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Total Horas
                                            </th>
                                            <th class="py-3 px-4 text-left">
                                                Reportes Incompletos
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-reporte-mensual">
                                        <!-- Los datos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Nueva sección: Reporte por Conductor -->
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <div class="flex space-x-2 mb-4" id="exportar-conductor">
                        <button
                            class="bg-red-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                            id="btn-descargar-reporte-conductor-pdf">
                            <i class="fas fa-file-pdf">
                            </i>
                            PDF
                        </button>
                        <button
                            class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                            id="btn-descargar-reporte-conductor-csv">
                            <i class="fas fa-file-csv">
                            </i>
                            CSV
                        </button>
                    </div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Reporte por Conductor
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Buscar Conductor
                            </label>
                            <div class="relative">
                                <input
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="buscar-conductor-reporte" placeholder="Nombre del conductor..." type="text" />
                                <div class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-10 hidden max-h-40 overflow-y-auto"
                                    id="resultados-conductor-reporte">
                                </div>
                            </div>
                            <!-- Elemento para mostrar el conductor seleccionado -->
                            <div class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-200 hidden" id="conductor-selected-reporte">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-blue-700">
                                        Conductor seleccionado: <span class="font-medium" id="conductor-nombre-reporte-display"></span>
                                    </span>
                                    <button type="button" class="text-blue-500 hover:text-blue-700" id="conductor-clear-reporte">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="conductor-id-reporte" />
                            <input type="hidden" id="conductor-nombre-reporte" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha Inicio
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-inicio-conductor" type="date" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha Fin
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-fin-conductor" type="date" />
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            id="btn-generar-reporte-conductor">
                            Generar Reporte
                        </button>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                            id="btn-limpiar-conductor">
                            Limpiar Filtros
                        </button>
                    </div>
                    <div class="mt-4 hidden" id="reporte-conductor-resultados">
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium mb-2 text-blue-800">
                                Resumen del Reporte
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Conductor:</span>
                                    <span class="font-medium" id="resumen-conductor-nombre">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Turnos:</span>
                                    <span class="font-medium" id="resumen-total-turnos">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Horas:</span>
                                    <span class="font-medium" id="resumen-total-horas">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Días Trabajados:</span>
                                    <span class="font-medium" id="resumen-dias-trabajados">0</span>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-medium mb-2 text-gray-700">
                            Detalle de Turnos
                        </h3>
                        <div class="table-container">
                            <table class="min-w-full bg-white">
                                <thead class="sticky top-0 bg-white">
                                    <tr class="bg-gray-100 text-gray-700">
                                        <th class="py-3 px-4 text-left">
                                            Fecha
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Unidad
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Turno
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Hora Inicio
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Hora Fin
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Horas Trabajadas
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Estado
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-reporte-conductor">
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Nueva sección: Reporte por Unidad -->
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <div class="flex space-x-2 mb-4" id="exportar-unidad">
                        <button
                            class="bg-red-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                            id="btn-descargar-reporte-unidad-pdf">
                            <i class="fas fa-file-pdf">
                            </i>
                            PDF
                        </button>
                        <button
                            class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:opacity-90 transition flex items-center gap-2"
                            id="btn-descargar-reporte-unidad-csv">
                            <i class="fas fa-file-csv">
                            </i>
                            CSV
                        </button>
                    </div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">
                        Reporte por Unidad
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Número de Unidad
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="numero-unidad-reporte" placeholder="Número de unidad (1-200)" type="number" min="1" max="200" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha Inicio
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-inicio-unidad" type="date" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha Fin
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="fecha-fin-unidad" type="date" />
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            id="btn-generar-reporte-unidad">
                            Generar Reporte
                        </button>
                        <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                            id="btn-limpiar-unidad">
                            Limpiar Filtros
                        </button>
                    </div>
                    <div class="mt-4 hidden" id="reporte-unidad-resultados">
                        <div class="mb-4 p-4 bg-green-50 rounded-lg">
                            <h3 class="font-medium mb-2 text-green-800">
                                Resumen del Reporte
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Unidad:</span>
                                    <span class="font-medium" id="resumen-unidad-numero">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Registros:</span>
                                    <span class="font-medium" id="resumen-total-registros">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Turnos:</span>
                                    <span class="font-medium" id="resumen-total-turnos-unidad">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Horas:</span>
                                    <span class="font-medium" id="resumen-total-horas-unidad">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Días Operados:</span>
                                    <span class="font-medium" id="resumen-dias-operados">0</span>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-medium mb-2 text-gray-700">
                            Historial de Operaciones
                        </h3>
                        <div class="table-container">
                            <table class="min-w-full bg-white">
                                <thead class="sticky top-0 bg-white">
                                    <tr class="bg-gray-100 text-gray-700">
                                        <th class="py-3 px-4 text-left">
                                            Fecha
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Conductor Turno 1
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Horas Turno 1
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Conductor Turno 2
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Horas Turno 2
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Total Turnos
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Total Horas
                                        </th>
                                        <th class="py-3 px-4 text-left">
                                            Estado
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-reporte-unidad">
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="content-chat">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-lg"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">
                                Asistente Virtual MotoTaxi
                            </h2>
                            <p class="text-sm text-gray-600">
                                Powered by OpenAI - Pregúntame lo que necesites
                            </p>
                        </div>
                    </div>
                    
                    <!-- Panel de chat principal -->
                    <div class="border rounded-lg flex flex-col h-96 mb-4">
                        <!-- Área de mensajes -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-mensajes">
                            <!-- Mensaje de bienvenida del bot -->
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm">
                                    🤖
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium text-sm text-blue-600">Asistente Virtual</span>
                                        <span class="text-xs text-gray-500" id="bot-time"></span>
                                    </div>
                                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-3 text-sm">
                                        ¡Hola! Soy tu asistente para consultar turnos y horarios de mototaxis. Pregúntame cosas como:
                                        <ul class="mt-2 space-y-1">
                                            <li>• "¿Qué turno tuvo la unidad 78 ayer?"</li>
                                            <li>• "¿Quién trabajó más en la última semana?"</li>
                                            <li>• "Turnos de hoy en la unidad 200"</li>
                                            <li>• "¿Quién trabajó más en el último mes?"</li>
                                        </ul>
                                        ¿Qué turnos quieres consultar?
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Área de escribir mensaje -->
                        <div class="border-t p-4">
                            <div class="flex gap-2">
                                <div
                                    contenteditable="true"
                                    data-placeholder="Escribe tu pregunta..."
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[40px] max-h-[120px] overflow-y-auto"
                                    id="chat-input"
                                    role="textbox"
                                    aria-label="Campo de chat para preguntas"
                                    style="line-height: 1.5;"
                                ></div>
                                <button
                                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition flex items-center gap-2 disabled:opacity-50"
                                    id="chat-enviar"
                                >
                                    <i class="fas fa-paper-plane"></i>
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel de configuración -->
                    <div class="bg-gray-50 border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-medium text-gray-700">
                                <i class="fas fa-cog mr-2"></i>
                                Configuración del Chatbot
                            </h3>
                            <button 
                                class="text-sm text-blue-600 hover:text-blue-800"
                                id="toggle-config"
                            >
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="hidden space-y-3" id="chat-config">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    API Key de OpenAI
                                </label>
                                <input
                                    type="password"
                                    placeholder="sk-..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    id="openai-api-key"
                                />
                                <p class="text-xs text-gray-500 mt-1">
                                    Tu API key se guarda localmente y no se envía al servidor
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Modelo
                                </label>
                                <select
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    id="openai-model"
                                >
                                    <option value="gpt-5-nano" selected>GPT-5 Nano</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    Modelo optimizado para consultas de turnos de mototaxis
                                </p>
                            </div>
                            <button
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
                                id="guardar-config"
                            >
                                <i class="fas fa-save mr-2"></i>
                                Guardar Configuración
                            </button>
                            <button
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm w-full"
                                id="limpiar-historial"
                            >
                                <i class="fas fa-trash mr-2"></i>
                                Limpiar Historial de Conversación
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de confirmación -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
        id="modal-confirmacion">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">
                Confirmar eliminación
            </h3>
            <p class="mb-6 text-gray-600">
                ¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede
                deshacer.
            </p>
            <div class="flex justify-end space-x-4">
                <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                    id="btn-cancelar-eliminar">
                    Cancelar
                </button>
                <button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                    id="btn-confirmar-eliminar">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
    let registroActual = null;
    let registroAEliminar = null;
    let choferes = [];
        
    // Variable para almacenar el historial del chatbot
    let historialChatbot = [];
    let currentUserRole = null;

        // Configuración de la API
        const API_BASE_URL = 'https://hclicknbusiness.com/Mototaxis/api/';
        const CACHE_BUSTER = '?v=' + Date.now();
        
        // Función para obtener token de sesión
        function getSessionToken() {
            return localStorage.getItem('session_token');
        }
        
        // Función para verificar autenticación
        async function checkAuth() {
            const token = getSessionToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            
            // Verificar que el token sea válido en el servidor
            try {
                const response = await fetch('api/auth-simple.php?action=verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        return true;
                    }
                }
                
                // Token inválido
                localStorage.removeItem('session_token');
                window.location.href = 'login.html';
                return false;
                
            } catch (error) {
                console.error('Error verificando auth:', error);
                // En caso de error de red, no redirigir inmediatamente
                return true;
            }
        }
        
        // Funciones de la API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = getSessionToken();
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (token || '')
                },
            };
            
            if (data && method !== 'GET') {
                if (typeof data === 'object') {
                    data.token = token; // Agregar token al body también
                }
                options.body = JSON.stringify(data);
            } else if (method === 'GET' && token) {
                // Para GET, agregar token como parámetro
                endpoint += (endpoint.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);
            }
            
            try {
                const url = API_BASE_URL + endpoint + (endpoint.includes('?') ? '&' : '?') + 'v=' + Date.now();
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (!response.ok) {
                    // Manejar error 401 (No autorizado)
                    if (response.status === 401) {
                        localStorage.removeItem('session_token');
                        localStorage.removeItem('user_data');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(result.message || result.error || 'Error en la API');
                }
                
                return result;
            } catch (error) {
                console.error('Error en API:', error);
                
                // Si es un error de red o conexión, mostrar mensaje
                if (error.message.includes('401') || error.message.includes('No autorizado')) {
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    window.location.href = 'login.html';
                } else {
                    alert('Error de conexión: ' + error.message);
                }
                throw error;
            }
        }

        function aplicarPermisosPorRol(user) {
            currentUserRole = (user && user.role) ? user.role.toLowerCase() : null;

            if (currentUserRole !== 'consultor') {
                // Asegurar que pestañas restringidas estén visibles para otros roles
                ['tab-control', 'tab-unidades', 'tab-choferes', 'tab-chat', 'mobile-tab-control', 'mobile-tab-unidades', 'mobile-tab-choferes', 'mobile-tab-chat'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('hidden');
                        el.removeAttribute('aria-hidden');
                        el.removeAttribute('disabled');
                    }
                });
                return;
            }

            // Ocultar pestañas no permitidas
            ['tab-control', 'tab-unidades', 'tab-choferes', 'tab-chat'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.setAttribute('aria-hidden', 'true');
                    el.setAttribute('disabled', 'true');
                    el.classList.remove('tab-active');
                }
            });

            ['mobile-tab-control', 'mobile-tab-unidades', 'mobile-tab-choferes', 'mobile-tab-chat'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.setAttribute('aria-hidden', 'true');
                    el.setAttribute('disabled', 'true');
                    el.classList.remove('tab-active');
                }
            });

            // Asegurar que solo la pestaña de reportes esté visible y activa
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));

            const reportTab = document.getElementById('tab-reportes');
            if (reportTab) {
                reportTab.classList.remove('hidden');
                reportTab.classList.add('tab-active');
            }

            const mobileReportTab = document.getElementById('mobile-tab-reportes');
            if (mobileReportTab) {
                mobileReportTab.classList.remove('hidden');
                mobileReportTab.classList.add('tab-active');
            }

            // Mostrar solo el contenido de reportes
            ['content-control', 'content-unidades', 'content-choferes', 'content-chat'].forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    content.classList.add('hidden');
                }
            });

            const reportContent = document.getElementById('content-reportes');
            if (reportContent) {
                reportContent.classList.remove('hidden');
            }

            // Mostrar mensaje informativo si existe contenedor
            const noticeContainer = document.getElementById('consultor-notice');
            if (noticeContainer) {
                noticeContainer.classList.remove('hidden');
            }
        }

        function getFechaLocalISO() {
            const fecha = new Date();
            const offset = fecha.getTimezoneOffset();
            const local = new Date(fecha.getTime() - offset * 60 * 1000);
            return local.toISOString().split('T')[0];
        }
    const fechaHoy = getFechaLocalISO();
    const TOTAL_UNIDADES = 200; // Total de unidades disponibles

        // Inicializar la conexión con la API (reemplaza IndexedDB)
        async function inicializarDB() {
            try {
                // Verificar que la API esté funcionando
                await apiCall('utils.php?action=stats');
                console.log('Conexión con la API establecida correctamente');
                
                // Cargar datos iniciales
                await cargarChoferes();
                await cargarRegistrosRecientes();

                // Establecer fecha actual en los campos de fecha
                document.getElementById('fecha-registro').value = fechaHoy;
                document.getElementById('fecha-reporte-diario').value = fechaHoy;
                document.getElementById('fecha-tabla-unidades').value = fechaHoy;
                
                // Establecer rango de fechas por defecto para reporte por conductor (último mes)
                const fechaHoyReporte = new Date();
                const fechaInicioMes = new Date(fechaHoyReporte.getFullYear(), fechaHoyReporte.getMonth(), 1);
                document.getElementById('fecha-inicio-conductor').value = fechaInicioMes.toISOString().split('T')[0];
                document.getElementById('fecha-fin-conductor').value = fechaHoyReporte.toISOString().split('T')[0];
                
                // Establecer rango de fechas por defecto para reporte por unidad (último mes)
                document.getElementById('fecha-inicio-unidad').value = fechaInicioMes.toISOString().split('T')[0];
                document.getElementById('fecha-fin-unidad').value = fechaHoyReporte.toISOString().split('T')[0];

                const hoy = new Date();
                document.getElementById('mes-reporte').value = hoy.getMonth() + 1;
                document.getElementById('anio-reporte').value = hoy.getFullYear();
            } catch (error) {
                console.error('Error al inicializar la conexión con la API:', error);
                alert('Error al conectar con el servidor. Verifica la configuración de la API.');
            }
        }

        // Funciones para gestionar choferes (usando API)
        async function cargarChoferes() {
            try {
                console.log('Cargando choferes...');
                const response = await apiCall('choferes.php');
                console.log('Respuesta completa:', response);
                
                // Extraer los datos del array
                choferes = response.data || response;
                console.log('Choferes extraídos:', choferes);
                
                actualizarTablaChoferes(choferes);
                console.log('Tabla actualizada');
            } catch (error) {
                console.error('Error al cargar choferes:', error);
            }
        }

        function actualizarTablaChoferes(choferes) {
            const tabla = document.getElementById('tabla-choferes');
            tabla.innerHTML = '';

            choferes.forEach(chofer => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td class="py-3 px-4 border-b">${chofer.nombre}</td>
                    <td class="py-3 px-4 border-b">
                        <button class="btn-icon btn-edit mr-2" data-id="${chofer.id}" data-nombre="${chofer.nombre}" data-action="edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" data-id="${chofer.id}" data-action="delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tabla.appendChild(fila);
            });
            
            // Agregar event listeners después de crear los botones
            agregarEventListenersTabla();
        }
        
        function agregarEventListenersTabla() {
            const tabla = document.getElementById('tabla-choferes');
            
            // Remover listeners anteriores
            tabla.removeEventListener('click', manejarClickTabla);
            
            // Agregar nuevo listener
            tabla.addEventListener('click', manejarClickTabla);
        }
        
        function manejarClickTabla(event) {
            const button = event.target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            const id = button.getAttribute('data-id');
            const nombre = button.getAttribute('data-nombre');
            
            console.log('Click en botón:', action, id, nombre);
            
            if (action === 'edit') {
                editarChofer(id, nombre);
            } else if (action === 'delete') {
                eliminarChofer(id);
            }
        }

        function buscarChoferes(searchTerm, resultadosElementId, choferIdElementId, choferNombreElementId, choferSelectedElementId) {
            const resultadosElement = document.getElementById(resultadosElementId);
            resultadosElement.innerHTML = '';

            if (!searchTerm.trim()) {
                resultadosElement.classList.add('hidden');
                return;
            }

            const termino = searchTerm.toLowerCase();
            const choferesFiltrados = choferes.filter(chofer =>
                chofer.nombre.toLowerCase().includes(termino)
            );

            if (choferesFiltrados.length === 0) {
                resultadosElement.innerHTML = '<div class="p-3 text-gray-500">No se encontraron Operadores</div>';
                resultadosElement.classList.remove('hidden');
                return;
            }

            choferesFiltrados.forEach(chofer => {
                const item = document.createElement('div');
                item.className = 'p-3 cursor-pointer chofer-item';
                item.textContent = chofer.nombre;
                item.addEventListener('click', () => {
                    document.getElementById(choferIdElementId).value = chofer.id;
                    document.getElementById(choferNombreElementId).textContent = chofer.nombre;
                    document.getElementById(choferSelectedElementId).classList.remove('hidden');
                    document.getElementById(resultadosElementId).classList.add('hidden');
                    document.getElementById(resultadosElementId.replace('-results', '-search')).value = '';
                    calcularTurnosYHoras();
                });
                resultadosElement.appendChild(item);
            });

            resultadosElement.classList.remove('hidden');
        }

        async function agregarChofer() {
            const nombreChofer = document.getElementById('nombre-chofer').value.trim();

            if (!nombreChofer) {
                alert('Por favor, ingresa el nombre del Operador');
                return;
            }

            try {
                console.log('Agregando chofer:', nombreChofer);
                
                const chofer = {
                    nombre: nombreChofer
                };

                const resultado = await apiCall('choferes.php', 'POST', chofer);
                console.log('Resultado de agregar chofer:', resultado);
                
                document.getElementById('nombre-chofer').value = '';
                
                console.log('Recargando lista de choferes...');
                await cargarChoferes();
                
                alert('Operador agregado correctamente');
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al agregar el operador: ' + error.message);
            }
        }

        async function eliminarChofer(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este Operador?')) {
                try {
                    await apiCall(`choferes.php?id=${id}`, 'DELETE');
                    await cargarChoferes();
                    alert('Operador eliminado correctamente');
                } catch (error) {
                    alert('Error al eliminar el operador: ' + error.message);
                }
            }
        }

        // Funciones para gestionar registros de unidades
        async function cargarRegistrosRecientes() {
            try {
                const response = await apiCall('registros.php');
                console.log('Response cargarRegistrosRecientes:', response);
                
                // Extraer los datos del response
                const data = response.data || response;
                console.log('Data extraída:', data);
                
                if (!Array.isArray(data)) {
                    console.log('Los datos no son un array, usando array vacío');
                    actualizarTablaRegistros([]);
                    return;
                }

                // Filtrar registros de los últimos 7 días
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - 7);
                const fechaLimiteStr = fechaLimite.toISOString().split('T')[0];
                
                const registrosFiltrados = data
                    .filter(registro => registro.fecha >= fechaLimiteStr)
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                    .slice(0, 20); // Limitar a 20 registros recientes

                actualizarTablaRegistros(registrosFiltrados);
            } catch (error) {
                console.error('Error al cargar registros recientes:', error);
                actualizarTablaRegistros([]);
            }
        }

        function actualizarTablaRegistros(registros) {
            const tabla = document.getElementById('tabla-registros');
            tabla.innerHTML = '';

            if (registros.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td colspan="12" class="py-3 px-4 border-b text-center">No hay registros recientes</td>
                `;
                tabla.appendChild(fila);
                return;
            }

            registros.forEach(registro => {
                const fila = document.createElement('tr');

                // Determinar el estado del registro
                let estadoBadge = '';
                if (registro.incompleto) {
                    estadoBadge = '<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Incompleto</span>';
                } else {
                    estadoBadge = '<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Completo</span>';
                }

                fila.innerHTML = `
                    <td class="py-3 px-4 border-b">${registro.fecha}</td>
                    <td class="py-3 px-4 border-b">${registro.unidad}</td>
                    <td class="py-3 px-4 border-b">${estadoBadge}</td>
                    <td class="py-3 px-4 border-b">${registro.chofer1Nombre || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.salida1 || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.llegada1 || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.chofer2Nombre || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.salida2 || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.llegada2 || '-'}</td>
                    <td class="py-3 px-4 border-b">${registro.turnos}</td>
                    <td class="py-3 px-4 border-b">${registro.horas.toFixed(2)}</td>
                    <td class="py-3 px-4 border-b">
                        <div class="flex space-x-2">
                            <button class="btn-icon btn-edit" data-id="${registro.id}" data-action="edit-registro">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete" data-id="${registro.id}" data-action="delete-registro">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;

                // Si el registro está marcado como incompleto, resaltar la fila
                if (registro.incompleto) {
                    fila.classList.add('bg-yellow-50');
                }

                tabla.appendChild(fila);
            });
            
            // Agregar event listeners después de crear los botones
            agregarEventListenersTablaRegistros();
        }
        
        function agregarEventListenersTablaRegistros() {
            const tabla = document.getElementById('tabla-registros');
            
            // Remover listeners anteriores
            tabla.removeEventListener('click', manejarClickTablaRegistros);
            
            // Agregar nuevo listener
            tabla.addEventListener('click', manejarClickTablaRegistros);
        }
        
        function manejarClickTablaRegistros(event) {
            const button = event.target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            const id = button.getAttribute('data-id');
            
            console.log('Click en botón registro:', action, id);
            
            if (action === 'edit-registro') {
                editarRegistro(id);
            } else if (action === 'delete-registro') {
                confirmarEliminarRegistro(id);
            }
        }

        async function buscarUnidad() {
            const numeroUnidad = parseInt(document.getElementById('search-unidad').value);

            if (isNaN(numeroUnidad) || numeroUnidad < 1 || numeroUnidad > 200) {
                alert('Por favor, ingresa un número de unidad válido (1-200)');
                return;
            }

            const fecha = document.getElementById('search-fecha').value;

            if (!fecha) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            try {
                console.log('Buscando unidad:', numeroUnidad, 'fecha:', fecha);
                
                // Obtener todos los registros
                const response = await apiCall('registros.php');
                const data = response.data || response;
                
                console.log('Datos obtenidos:', data);
                
                if (!Array.isArray(data)) {
                    console.log('Los datos no son un array');
                    nuevoRegistro(numeroUnidad, fecha);
                    return;
                }

                // Buscar registro para esta unidad y fecha
                const registroEncontrado = data.find(registro => 
                    registro.unidad == numeroUnidad && registro.fecha === fecha
                );

                console.log('Registro encontrado:', registroEncontrado);

                if (registroEncontrado) {
                    mostrarDetallesUnidad(registroEncontrado);
                } else {
                    // No se encontró registro para esta unidad y fecha
                    nuevoRegistro(numeroUnidad, fecha);
                }
                
            } catch (error) {
                console.error('Error al buscar unidad:', error);
                alert('Error al buscar la unidad: ' + error.message);
            }
        }

        function nuevoRegistro(numeroUnidad = null, fecha = null) {
            // Limpiar formulario
            document.getElementById('chofer1-id').value = '';
            document.getElementById('chofer1-search').value = '';
            document.getElementById('chofer1-selected').classList.add('hidden');
            document.getElementById('salida1').value = '';
            document.getElementById('llegada1').value = '';
            document.getElementById('chofer2-id').value = '';
            document.getElementById('chofer2-search').value = '';
            document.getElementById('chofer2-selected').classList.add('hidden');
            document.getElementById('salida2').value = '';
            document.getElementById('llegada2').value = '';
            document.getElementById('total-turnos').textContent = '0';
            document.getElementById('total-horas').textContent = '0';
            document.getElementById('marcar-incompleto').checked = false;

            // Ocultar el badge de estado
            const estadoBadge = document.getElementById('estado-registro-badge');
            estadoBadge.classList.add('hidden');

            if (numeroUnidad) {
                document.getElementById('unidad-numero').textContent = numeroUnidad;
            } else {
                const unidadBuscada = document.getElementById('search-unidad').value;
                if (unidadBuscada && !isNaN(parseInt(unidadBuscada))) {
                    document.getElementById('unidad-numero').textContent = unidadBuscada;
                } else {
                    document.getElementById('unidad-numero').textContent = '';
                    document.getElementById('search-unidad').value = '';
                }
            }

            // Establecer la fecha en el campo de fecha-registro
            if (fecha) {
                document.getElementById('fecha-registro').value = fecha;
            } else {
                // Si no se proporciona fecha, usar la fecha del buscador o la actual
                const fechaBuscador = document.getElementById('search-fecha').value;
                if (fechaBuscador) {
                    document.getElementById('fecha-registro').value = fechaBuscador;
                } else {
                    const today = new Date();
                    const fechaActual = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
                    document.getElementById('fecha-registro').value = fechaActual;
                }
            }

            registroActual = null;
            document.getElementById('unidad-details').classList.remove('hidden');
            
            // Actualizar texto del botón
            actualizarTextoBotonGuardar();
        }

        function crearNuevoRegistroActual() {
            // Obtener la unidad actual antes de limpiar
            const unidadActual = document.getElementById('unidad-numero').textContent;
            
            // Limpiar el registro actual para forzar la creación de uno nuevo
            registroActual = null;
            
            // Limpiar formulario manteniendo solo la unidad
            document.getElementById('chofer1-id').value = '';
            document.getElementById('chofer1-search').value = '';
            document.getElementById('chofer1-selected').classList.add('hidden');
            document.getElementById('salida1').value = '';
            document.getElementById('llegada1').value = '';
            document.getElementById('chofer2-id').value = '';
            document.getElementById('chofer2-search').value = '';
            document.getElementById('chofer2-selected').classList.add('hidden');
            document.getElementById('salida2').value = '';
            document.getElementById('llegada2').value = '';
            document.getElementById('total-turnos').textContent = '0';
            document.getElementById('total-horas').textContent = '0';
            document.getElementById('marcar-incompleto').checked = false;
            
            // Establecer fecha actual
            document.getElementById('fecha-registro').value = getFechaLocalISO();

            // Ocultar el badge de estado
            const estadoBadge = document.getElementById('estado-registro-badge');
            estadoBadge.classList.add('hidden');
            
            // Mantener la unidad actual
            if (unidadActual) {
                document.getElementById('unidad-numero').textContent = unidadActual;
            }
            
            // Actualizar texto del botón
            actualizarTextoBotonGuardar();
        }

        function actualizarTextoBotonGuardar() {
            const botonGuardar = document.getElementById('btn-guardar');
            if (registroActual) {
                botonGuardar.innerHTML = 'Actualizar<br>Registro';
            } else {
                botonGuardar.innerHTML = 'Guardar<br>Registro';
            }
        }

        function mostrarDetallesUnidad(registro) {
            console.log('mostrarDetallesUnidad llamada con:', registro);
            registroActual = registro;

            document.getElementById('unidad-numero').textContent = registro.unidad;
            document.getElementById('fecha-registro').value = registro.fecha;

            // Configurar chofer 1
            if (registro.chofer1) {
                document.getElementById('chofer1-id').value = registro.chofer1;
                document.getElementById('chofer1-nombre').textContent = registro.chofer1Nombre;
                document.getElementById('chofer1-selected').classList.remove('hidden');
            } else {
                document.getElementById('chofer1-id').value = '';
                document.getElementById('chofer1-selected').classList.add('hidden');
            }

            document.getElementById('salida1').value = registro.salida1 || '';
            document.getElementById('llegada1').value = registro.llegada1 || '';

            // Configurar chofer 2
            if (registro.chofer2) {
                document.getElementById('chofer2-id').value = registro.chofer2;
                document.getElementById('chofer2-nombre').textContent = registro.chofer2Nombre;
                document.getElementById('chofer2-selected').classList.remove('hidden');
            } else {
                document.getElementById('chofer2-id').value = '';
                document.getElementById('chofer2-selected').classList.add('hidden');
            }

            document.getElementById('salida2').value = registro.salida2 || '';
            document.getElementById('llegada2').value = registro.llegada2 || '';

            document.getElementById('total-turnos').textContent = registro.turnos;
            document.getElementById('total-horas').textContent = registro.horas.toFixed(2);

            // Configurar el estado de incompleto
            document.getElementById('marcar-incompleto').checked = registro.incompleto || false;

            // Mostrar el badge de estado
            const estadoBadge = document.getElementById('estado-registro-badge');
            estadoBadge.classList.remove('hidden', 'badge-completo', 'badge-incompleto');

            if (registro.incompleto) {
                estadoBadge.classList.add('badge-incompleto');
                estadoBadge.textContent = 'Reporte Incompleto';
            } else {
                estadoBadge.classList.add('badge-completo');
                estadoBadge.textContent = 'Reporte Completo';
            }

            document.getElementById('unidad-details').classList.remove('hidden');
            
            // Actualizar texto del botón
            actualizarTextoBotonGuardar();
        }

        function calcularTurnosYHoras() {
            const salida1 = document.getElementById('salida1').value;
            const llegada1 = document.getElementById('llegada1').value;
            const salida2 = document.getElementById('salida2').value;
            const llegada2 = document.getElementById('llegada2').value;

            let turnos = 0;
            let horasTotales = 0;

            // Caso especial: si hay salida 1 y llegada 2 (sin llegada 1 ni salida 2), se consideran 2 turnos
            if (salida1 && !llegada1 && !salida2 && llegada2) {
                turnos = 2;
                horasTotales = calcularHorasEntreTiempos(salida1, llegada2);
            } else {
                // Calcular turnos según la regla normal
                if (salida1 && llegada1) {
                    // Si hay salida 1 y llegada 1, se considera 1 turno
                    turnos = 1;
                    horasTotales += calcularHorasEntreTiempos(salida1, llegada1);
                } else if (salida1) {
                    // Si solo hay salida 1, se considera 0 turnos
                    turnos = 0;
                    horasTotales = 0;
                }

                if (salida2 && llegada2) {
                    // Si hay salida 2 y llegada 2, se suma 1 turno más
                    turnos += 1;
                    horasTotales += calcularHorasEntreTiempos(salida2, llegada2);
                } else if (salida2) {
                    // Si solo hay salida 2, no se suma turno
                    turnos += 0;
                }
            }

            document.getElementById('total-turnos').textContent = turnos;
            document.getElementById('total-horas').textContent = horasTotales.toFixed(2);

            return { turnos, horas: horasTotales };
        }

        function calcularHorasEntreTiempos(salida, llegada) {
            if (!salida || !llegada) return 0;

            const [horaSalida, minutoSalida] = salida.split(':').map(Number);
            const [horaLlegada, minutoLlegada] = llegada.split(':').map(Number);

            let horas = horaLlegada - horaSalida;
            let minutos = minutoLlegada - minutoSalida;

            if (minutos < 0) {
                horas--;
                minutos += 60;
            }

            if (horas < 0) {
                horas += 24; // Asumimos que el turno cruza la medianoche
            }

            return horas + (minutos / 60);
        }

        async function guardarRegistro() {
            const numeroUnidad = parseInt(document.getElementById('unidad-numero').textContent);

            if (isNaN(numeroUnidad) || numeroUnidad < 1 || numeroUnidad > 200) {
                alert('Por favor, ingresa un número de unidad válido (1-200)');
                return;
            }

            const fecha = document.getElementById('fecha-registro').value;

            if (!fecha) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            const chofer1Id = document.getElementById('chofer1-id').value;
            const chofer1Nombre = chofer1Id ? document.getElementById('chofer1-nombre').textContent : '';
            const salida1 = document.getElementById('salida1').value;
            const llegada1 = document.getElementById('llegada1').value;

            const chofer2Id = document.getElementById('chofer2-id').value;
            const chofer2Nombre = chofer2Id ? document.getElementById('chofer2-nombre').textContent : '';
            const salida2 = document.getElementById('salida2').value;
            const llegada2 = document.getElementById('llegada2').value;

            // Validar que al menos haya una hora de salida
            if (!salida1 && !salida2) {
                alert('Por favor, ingresa al menos una hora de salida');
                return;
            }

            // Calcular turnos y horas
            const { turnos, horas } = calcularTurnosYHoras();

            // Obtener el estado de incompleto
            const incompleto = document.getElementById('marcar-incompleto').checked;

            const registro = {
                unidad: numeroUnidad,
                fecha: fecha,
                chofer1: chofer1Id,
                chofer1Nombre: chofer1Nombre,
                salida1: salida1,
                llegada1: llegada1,
                chofer2: chofer2Id,
                chofer2Nombre: chofer2Nombre,
                salida2: salida2,
                llegada2: llegada2,
                turnos: turnos,
                horas: horas,
                incompleto: incompleto
            };

            try {
                let response;
                if (registroActual) {
                    // Editar registro existente
                    registro.id = registroActual.id;
                    console.log('Editando registro:', registro);
                    response = await apiCall(`registros.php?id=${registro.id}`, 'PUT', registro);
                } else {
                    // Crear nuevo registro
                    console.log('Creando nuevo registro:', registro);
                    response = await apiCall('registros.php', 'POST', registro);
                }

                console.log('Respuesta del servidor:', response);
                
                // response ya es el JSON parseado
                if (!response.success) {
                    throw new Error(response.message || 'Error al guardar el registro');
                }

                alert('Registro guardado correctamente');
                document.getElementById('unidad-details').classList.add('hidden');
                await cargarRegistrosRecientes();
            } catch (error) {
                console.error('Error al guardar registro:', error);
                alert('Error al guardar el registro: ' + error.message);
            }
        }

        async function editarRegistro(id) {
            try {
                const response = await apiCall(`registros.php?id=${id}`);
                console.log('Respuesta editar registro:', response);
                
                // response ya es el JSON parseado
                if (!response.success) {
                    throw new Error(response.message || 'Error al cargar el registro');
                }

                if (response.data) {
                    mostrarDetallesUnidad(response.data);
                }
            } catch (error) {
                console.error('Error al cargar registro:', error);
                alert('Error al cargar el registro: ' + error.message);
            }
        }

        function confirmarEliminarRegistro(id) {
            registroAEliminar = id;
            document.getElementById('modal-confirmacion').classList.remove('hidden');
        }

        async function eliminarRegistro() {
            if (!registroAEliminar) return;

            try {
                console.log('Eliminando registro:', registroAEliminar);
                const response = await apiCall(`registros.php?id=${registroAEliminar}`, 'DELETE');
                console.log('Respuesta eliminar:', response);
                
                // response ya es el JSON parseado
                if (!response.success) {
                    throw new Error(response.message || 'Error al eliminar el registro');
                }

                document.getElementById('modal-confirmacion').classList.add('hidden');
                registroAEliminar = null;
                await cargarRegistrosRecientes();
                alert('Registro eliminado correctamente');
            } catch (error) {
                console.error('Error al eliminar registro:', error);
                alert('Error al eliminar el registro: ' + error.message);
            }
        }

        // Funciones para la tabla general de unidades
        async function cargarTablaUnidades() {
            const fecha = document.getElementById('fecha-tabla-unidades').value;
            const filtro = document.getElementById('filtro-unidades').value;

            if (!fecha) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            try {
                // Obtener todos los registros para la fecha seleccionada
                const response = await apiCall('registros.php');
                console.log('Response cargarTablaUnidades:', response);
                
                // Extraer los datos del response
                const data = response.data || response;
                console.log('Data extraída:', data);
                
                if (!Array.isArray(data)) {
                    throw new Error('Los datos no tienen el formato esperado');
                }

                const registrosFecha = data.filter(registro => registro.fecha === fecha);
                const registrosPorUnidad = {};

                // Organizar registros por unidad
                registrosFecha.forEach(registro => {
                    registrosPorUnidad[registro.unidad] = registro;
                });

                // Generar tabla según el filtro seleccionado
                const tabla = document.getElementById('tabla-todas-unidades');
                tabla.innerHTML = '';

                // Crear array de unidades según el filtro
                let unidades = [];

                if (filtro === 'todas') {
                    // Mostrar todas las unidades (1-200)
                    for (let i = 1; i <= TOTAL_UNIDADES; i++) {
                        unidades.push(i);
                    }
                } else if (filtro === 'con-registro') {
                    // Mostrar solo unidades con registro
                    unidades = Object.keys(registrosPorUnidad).map(Number);
                } else if (filtro === 'sin-registro') {
                    // Mostrar solo unidades sin registro
                    const unidadesConRegistro = new Set(Object.keys(registrosPorUnidad).map(Number));
                    for (let i = 1; i <= TOTAL_UNIDADES; i++) {
                        if (!unidadesConRegistro.has(i)) {
                            unidades.push(i);
                        }
                    }
                } else if (filtro === 'incompletas') {
                    // Mostrar solo unidades con registros incompletos
                    for (const unidad in registrosPorUnidad) {
                        if (registrosPorUnidad[unidad].incompleto) {
                            unidades.push(Number(unidad));
                        }
                    }
                }

                // Ordenar unidades numéricamente
                unidades.sort((a, b) => a - b);

                if (unidades.length === 0) {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td colspan="5" class="py-3 px-4 border-b text-center">No hay unidades que coincidan con el filtro</td>
                    `;
                    tabla.appendChild(fila);
                    return;
                }

                // Generar filas para cada unidad
                unidades.forEach(unidad => {
                    const registro = registrosPorUnidad[unidad];
                    const fila = document.createElement('tr');

                    if (registro) {
                        // Determinar el estado del registro
                        let estadoBadge = '';
                        let estadoClase = '';

                        if (registro.incompleto) {
                            estadoBadge = '<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Incompleto</span>';
                            estadoClase = 'bg-yellow-50';
                        } else {
                            estadoBadge = '<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Completo</span>';
                        }

                        // Unidad con registro
                        fila.innerHTML = `
                            <td class="py-3 px-4 border-b">${unidad}</td>
                            <td class="py-3 px-4 border-b">${estadoBadge}</td>
                            <td class="py-3 px-4 border-b">${registro.turnos}</td>
                            <td class="py-3 px-4 border-b">${registro.horas.toFixed(2)}</td>
                            <td class="py-3 px-4 border-b">
                                <button class="btn-icon btn-edit" data-id="${registro.id}" data-action="edit-unidad">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;

                        // Si el registro está marcado como incompleto, resaltar la fila
                        if (registro.incompleto) {
                            fila.classList.add(estadoClase);
                        }
                    } else {
                        // Unidad sin registro
                        fila.innerHTML = `
                            <td class="py-3 px-4 border-b">${unidad}</td>
                            <td class="py-3 px-4 border-b">
                                <span class="px-2 py-1 badge-sin-registro rounded-full text-xs font-medium">Sin registro</span>
                            </td>
                            <td class="py-3 px-4 border-b">0</td>
                            <td class="py-3 px-4 border-b">0.00</td>
                            <td class="py-3 px-4 border-b">
                                <button class="btn-icon btn-add" data-unidad="${unidad}" data-action="add-unidad">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </td>
                        `;
                    }

                    tabla.appendChild(fila);
                });
                
                // Agregar event listeners después de crear los botones
                agregarEventListenersTablaUnidades();
            } catch (error) {
                alert('Error al cargar la tabla de unidades: ' + error.message);
            }
        }
        
        function agregarEventListenersTablaUnidades() {
            const tabla = document.getElementById('tabla-todas-unidades');
            
            // Remover listeners anteriores
            tabla.removeEventListener('click', manejarClickTablaUnidades);
            
            // Agregar nuevo listener
            tabla.addEventListener('click', manejarClickTablaUnidades);
        }
        
        function manejarClickTablaUnidades(event) {
            const button = event.target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            const id = button.getAttribute('data-id');
            const unidad = button.getAttribute('data-unidad');
            
            console.log('Click en botón unidad:', action, id, unidad);
            
            if (action === 'edit-unidad') {
                editarRegistroDesdeTabla(id);
            } else if (action === 'add-unidad') {
                crearRegistroDesdeTabla(unidad);
            }
        }

        function editarRegistroDesdeTabla(id) {
            console.log('editarRegistroDesdeTabla llamada con ID:', id);
            
            // Cambiar a la pestaña de control
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById('content-control').classList.remove('hidden');

            document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('tab-control').classList.add('tab-active');

            // Editar el registro
            console.log('Llamando a editarRegistro con ID:', id);
            editarRegistro(id);
        }

        function crearRegistroDesdeTabla(unidad) {
            // Cambiar a la pestaña de control
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById('content-control').classList.remove('hidden');

            document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('tab-control').classList.add('tab-active');

            // Establecer la fecha seleccionada en la tabla
            document.getElementById('fecha-registro').value = document.getElementById('fecha-tabla-unidades').value;

            // Crear nuevo registro
            nuevoRegistro(unidad);
        }

        // Funciones para reportes
        async function generarReporteDiario() {
            const fecha = document.getElementById('fecha-reporte-diario').value;

            if (!fecha) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            try {
                const data = await apiCall('registros.php');
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar registros');
                }

                const registrosFecha = data.data.filter(registro => registro.fecha === fecha);
                mostrarReporteDiario(registrosFecha);
            } catch (error) {
                alert('Error al generar el reporte: ' + error.message);
            }
        }

        function mostrarReporteDiario(registros) {
            const tabla = document.getElementById('tabla-reporte-diario');
            tabla.innerHTML = '';

            if (registros.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td colspan="5" class="py-3 px-4 border-b text-center">No hay registros para esta fecha</td>
                `;
                tabla.appendChild(fila);
            } else {
                registros.forEach(registro => {
                    // Determinar el estado del registro
                    let estadoBadge = '';
                    let estadoClase = '';

                    if (registro.incompleto) {
                        estadoBadge = '<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Incompleto</span>';
                        estadoClase = 'bg-yellow-50';
                    } else {
                        estadoBadge = '<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Completo</span>';
                    }

                    // Caso especial: si hay salida 1 y llegada 2 (sin llegada 1 ni salida 2), se consideran 2 turnos
                    if (registro.salida1 && !registro.llegada1 && !registro.salida2 && registro.llegada2) {
                        const fila = document.createElement('tr');
                        const horas = calcularHorasEntreTiempos(registro.salida1, registro.llegada2);
                        fila.innerHTML = `
                            <td class="py-3 px-4 border-b">${registro.unidad}</td>
                            <td class="py-3 px-4 border-b">${estadoBadge}</td>
                            <td class="py-3 px-4 border-b">${registro.chofer1Nombre || '-'}</td>
                            <td class="py-3 px-4 border-b">2</td>
                            <td class="py-3 px-4 border-b">${horas.toFixed(2)}</td>
                        `;

                        if (registro.incompleto) {
                            fila.classList.add(estadoClase);
                        }

                        tabla.appendChild(fila);
                    } else {
                        // Crear fila para el primer turno si existe y tiene llegada
                        if (registro.salida1 && registro.llegada1) {
                            const fila1 = document.createElement('tr');
                            const horas1 = calcularHorasEntreTiempos(registro.salida1, registro.llegada1);
                            fila1.innerHTML = `
                                <td class="py-3 px-4 border-b">${registro.unidad}</td>
                                <td class="py-3 px-4 border-b">${estadoBadge}</td>
                                <td class="py-3 px-4 border-b">${registro.chofer1Nombre || '-'}</td>
                                <td class="py-3 px-4 border-b">1</td>
                                <td class="py-3 px-4 border-b">${horas1.toFixed(2)}</td>
                            `;

                            if (registro.incompleto) {
                                fila1.classList.add(estadoClase);
                            }

                            tabla.appendChild(fila1);
                        } else if (registro.salida1) {
                            // Si solo hay salida 1 (sin llegada), mostrar 0 turnos
                            const fila1 = document.createElement('tr');
                            fila1.innerHTML = `
                                <td class="py-3 px-4 border-b">${registro.unidad}</td>
                                <td class="py-3 px-4 border-b">${estadoBadge}</td>
                                <td class="py-3 px-4 border-b">${registro.chofer1Nombre || '-'}</td>
                                <td class="py-3 px-4 border-b">0</td>
                                <td class="py-3 px-4 border-b">0.00</td>
                            `;

                            if (registro.incompleto) {
                                fila1.classList.add(estadoClase);
                            }

                            tabla.appendChild(fila1);
                        }

                        // Crear fila para el segundo turno si existe y tiene llegada
                        if (registro.salida2 && registro.llegada2) {
                            const fila2 = document.createElement('tr');
                            const horas2 = calcularHorasEntreTiempos(registro.salida2, registro.llegada2);
                            fila2.innerHTML = `
                                <td class="py-3 px-4 border-b">${registro.unidad}</td>
                                <td class="py-3 px-4 border-b">${estadoBadge}</td>
                                <td class="py-3 px-4 border-b">${registro.chofer2Nombre || '-'}</td>
                                <td class="py-3 px-4 border-b">1</td>
                                <td class="py-3 px-4 border-b">${horas2.toFixed(2)}</td>
                            `;

                            if (registro.incompleto) {
                                fila2.classList.add(estadoClase);
                            }

                            tabla.appendChild(fila2);
                        } else if (registro.salida2) {
                            // Si solo hay salida 2 (sin llegada), mostrar 0 turnos
                            const fila2 = document.createElement('tr');
                            fila2.innerHTML = `
                                <td class="py-3 px-4 border-b">${registro.unidad}</td>
                                <td class="py-3 px-4 border-b">${estadoBadge}</td>
                                <td class="py-3 px-4 border-b">${registro.chofer2Nombre || '-'}</td>
                                <td class="py-3 px-4 border-b">0</td>
                                <td class="py-3 px-4 border-b">0.00</td>
                            `;

                            if (registro.incompleto) {
                                fila2.classList.add(estadoClase);
                            }

                            tabla.appendChild(fila2);
                        }
                    }
                });
            }

            document.getElementById('reporte-diario-resultados').classList.remove('hidden');
        }

        async function generarReporteMensual() {
            const mes = parseInt(document.getElementById('mes-reporte').value);
            const anio = parseInt(document.getElementById('anio-reporte').value);

            if (isNaN(mes) || mes < 1 || mes > 12 || isNaN(anio) || anio < 2000 || anio > 2100) {
                alert('Por favor, selecciona un mes y año válidos');
                return;
            }

            try {
                const data = await apiCall('registros.php');
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar registros');
                }

                const registrosFiltrados = data.data.filter(registro => {
                    // Usar parsing manual para evitar problemas de timezone
                    const fechaParts = registro.fecha.split('-');
                    const anioRegistro = parseInt(fechaParts[0]);
                    const mesRegistro = parseInt(fechaParts[1]);
                    
                    return mesRegistro === mes && anioRegistro === anio;
                });

                mostrarReporteMensual(registrosFiltrados);
            } catch (error) {
                alert('Error al generar el reporte mensual: ' + error.message);
            }
        }

        function mostrarReporteMensual(registros) {
            const tabla = document.getElementById('tabla-reporte-mensual');
            tabla.innerHTML = '';

            if (registros.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td colspan="5" class="py-3 px-4 border-b text-center">No hay registros para este mes</td>
                `;
                tabla.appendChild(fila);
                document.getElementById('reporte-mensual-resultados').classList.remove('hidden');
                return;
            }

            // Agrupar registros por unidad
            const unidades = {};

            registros.forEach(registro => {
                if (!unidades[registro.unidad]) {
                    unidades[registro.unidad] = {
                        turnos: 0,
                        horas: 0,
                        reportesIncompletos: 0
                    };
                }

                unidades[registro.unidad].turnos += registro.turnos;
                unidades[registro.unidad].horas += registro.horas;

                if (registro.incompleto) {
                    unidades[registro.unidad].reportesIncompletos += 1;
                }
            });

            // Mostrar resultados
            Object.keys(unidades).sort((a, b) => parseInt(a) - parseInt(b)).forEach(unidad => {
                const fila = document.createElement('tr');
                const datos = unidades[unidad];

                // Determinar el estado general de la unidad
                let estadoBadge = '';
                let estadoClase = '';

                if (datos.reportesIncompletos > 0) {
                    estadoBadge = `<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Con reportes incompletos</span>`;
                    estadoClase = 'bg-yellow-50';
                } else {
                    estadoBadge = `<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Todos completos</span>`;
                }

                fila.innerHTML = `
                    <td class="py-3 px-4 border-b">${unidad}</td>
                    <td class="py-3 px-4 border-b">${estadoBadge}</td>
                    <td class="py-3 px-4 border-b">${datos.turnos}</td>
                    <td class="py-3 px-4 border-b">${datos.horas.toFixed(2)}</td>
                    <td class="py-3 px-4 border-b">${datos.reportesIncompletos}</td>
                `;

                if (datos.reportesIncompletos > 0) {
                    fila.classList.add(estadoClase);
                }

                tabla.appendChild(fila);
            });

            document.getElementById('reporte-mensual-resultados').classList.remove('hidden');
        }

        // Función para generar reporte por conductor
        async function generarReportePorConductor() {
            const conductorId = document.getElementById('conductor-id-reporte').value;
            const conductorNombre = document.getElementById('conductor-nombre-reporte').value;
            const fechaInicio = document.getElementById('fecha-inicio-conductor').value;
            const fechaFin = document.getElementById('fecha-fin-conductor').value;

            if (!conductorId) {
                alert('Por favor, selecciona un conductor');
                return;
            }

            if (!fechaInicio || !fechaFin) {
                alert('Por favor, selecciona el rango de fechas');
                return;
            }

            if (new Date(fechaInicio) > new Date(fechaFin)) {
                alert('La fecha de inicio no puede ser posterior a la fecha de fin');
                return;
            }

            try {
                const data = await apiCall('registros.php');
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar registros');
                }

                // Filtrar registros por conductor y rango de fechas
                const registrosFiltrados = data.data.filter(registro => {
                    // Usar comparación directa de strings para evitar problemas de timezone
                    const fechaRegistro = registro.fecha;
                    
                    const dentroDeFechas = fechaRegistro >= fechaInicio && fechaRegistro <= fechaFin;
                    
                    // Verificar si el conductor está en alguno de los turnos
                    const esConductorTurno1 = registro.chofer1 === conductorId;
                    const esConductorTurno2 = registro.chofer2 === conductorId;
                    
                    return dentroDeFechas && (esConductorTurno1 || esConductorTurno2);
                });

                mostrarReportePorConductor(registrosFiltrados, conductorNombre, fechaInicio, fechaFin);
            } catch (error) {
                alert('Error al generar el reporte por conductor: ' + error.message);
            }
        }

        function mostrarReportePorConductor(registros, conductorNombre, fechaInicio, fechaFin) {
            const tabla = document.getElementById('tabla-reporte-conductor');
            tabla.innerHTML = '';

            let totalTurnos = 0;
            let totalHoras = 0;
            let diasTrabajados = new Set();
            let turnosDetallados = [];

            if (registros.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td colspan="7" class="py-3 px-4 border-b text-center text-gray-500">
                        No se encontraron registros para este conductor en el rango de fechas seleccionado
                    </td>
                `;
                tabla.appendChild(fila);
            } else {
                registros.forEach(registro => {
                    const conductorId = document.getElementById('conductor-id-reporte').value;
                    
                    // Verificar turno 1
                    if (registro.chofer1 === conductorId && registro.salida1) {
                        diasTrabajados.add(registro.fecha);
                        let estadoTurno = 'Incompleto';
                        let horasTrabajadasTurno = 0;
                        let horaFin = '-';
                        
                        if (registro.llegada1) {
                            estadoTurno = 'Completo';
                            horasTrabajadasTurno = calcularHorasEntreTiempos(registro.salida1, registro.llegada1);
                            horaFin = registro.llegada1;
                        }
                        
                        totalTurnos++;
                        totalHoras += horasTrabajadasTurno;
                        
                        turnosDetallados.push({
                            fecha: registro.fecha,
                            unidad: registro.unidad,
                            turno: 1,
                            horaInicio: registro.salida1,
                            horaFin: horaFin,
                            horasTrabajadas: horasTrabajadasTurno,
                            estado: estadoTurno
                        });
                    }
                    
                    // Verificar turno 2
                    if (registro.chofer2 === conductorId && registro.salida2) {
                        diasTrabajados.add(registro.fecha);
                        let estadoTurno = 'Incompleto';
                        let horasTrabajadasTurno = 0;
                        let horaFin = '-';
                        
                        if (registro.llegada2) {
                            estadoTurno = 'Completo';
                            horasTrabajadasTurno = calcularHorasEntreTiempos(registro.salida2, registro.llegada2);
                            horaFin = registro.llegada2;
                        }
                        
                        totalTurnos++;
                        totalHoras += horasTrabajadasTurno;
                        
                        turnosDetallados.push({
                            fecha: registro.fecha,
                            unidad: registro.unidad,
                            turno: 2,
                            horaInicio: registro.salida2,
                            horaFin: horaFin,
                            horasTrabajadas: horasTrabajadasTurno,
                            estado: estadoTurno
                        });
                    }
                    
                    // Caso especial: si hay salida1 y llegada2 sin llegada1 ni salida2 (doble turno)
                    if (registro.chofer1 === conductorId && registro.salida1 && !registro.llegada1 && !registro.salida2 && registro.llegada2) {
                        diasTrabajados.add(registro.fecha);
                        const horasTrabajadasDoble = calcularHorasEntreTiempos(registro.salida1, registro.llegada2);
                        
                        totalTurnos += 2; // Se considera como 2 turnos
                        totalHoras += horasTrabajadasDoble;
                        
                        turnosDetallados.push({
                            fecha: registro.fecha,
                            unidad: registro.unidad,
                            turno: 'Doble',
                            horaInicio: registro.salida1,
                            horaFin: registro.llegada2,
                            horasTrabajadas: horasTrabajadasDoble,
                            estado: 'Completo'
                        });
                    }
                });

                // Ordenar turnos por fecha (usando comparación de strings)
                turnosDetallados.sort((a, b) => a.fecha.localeCompare(b.fecha));

                // Agregar filas a la tabla
                turnosDetallados.forEach(turno => {
                    const fila = document.createElement('tr');
                    
                    let estadoBadge = '';
                    if (turno.estado === 'Completo') {
                        estadoBadge = '<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Completo</span>';
                    } else {
                        estadoBadge = '<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Incompleto</span>';
                        fila.classList.add('bg-yellow-50');
                    }
                    
                    fila.innerHTML = `
                        <td class="py-3 px-4 border-b">${formatearFecha(turno.fecha)}</td>
                        <td class="py-3 px-4 border-b">${turno.unidad}</td>
                        <td class="py-3 px-4 border-b">${turno.turno}</td>
                        <td class="py-3 px-4 border-b">${turno.horaInicio}</td>
                        <td class="py-3 px-4 border-b">${turno.horaFin}</td>
                        <td class="py-3 px-4 border-b">${turno.horasTrabajadas.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">${estadoBadge}</td>
                    `;
                    
                    tabla.appendChild(fila);
                });
            }

            // Actualizar resumen
            document.getElementById('resumen-conductor-nombre').textContent = conductorNombre;
            document.getElementById('resumen-total-turnos').textContent = totalTurnos;
            document.getElementById('resumen-total-horas').textContent = totalHoras.toFixed(2);
            document.getElementById('resumen-dias-trabajados').textContent = diasTrabajados.size;

            // Mostrar resultados
            document.getElementById('reporte-conductor-resultados').classList.remove('hidden');
        }

        function formatearFecha(fechaISO) {
            // Usar parsing manual para evitar problemas de timezone
            const fechaParts = fechaISO.split('-');
            const year = fechaParts[0];
            const month = fechaParts[1];
            const day = fechaParts[2];
            
            return `${day}/${month}/${year}`;
        }

        function buscarChoferesReporte(searchTerm) {
            const resultadosElement = document.getElementById('resultados-conductor-reporte');
            resultadosElement.innerHTML = '';

            if (!searchTerm.trim()) {
                resultadosElement.classList.add('hidden');
                return;
            }

            const termino = searchTerm.toLowerCase();
            const choferesFiltrados = choferes.filter(chofer =>
                chofer.nombre.toLowerCase().includes(termino)
            );

            if (choferesFiltrados.length === 0) {
                resultadosElement.innerHTML = '<div class="p-3 text-gray-500">No se encontraron Operadores</div>';
                resultadosElement.classList.remove('hidden');
                return;
            }

            choferesFiltrados.forEach(chofer => {
                const item = document.createElement('div');
                item.className = 'p-3 cursor-pointer chofer-item';
                item.textContent = chofer.nombre;
                item.addEventListener('click', () => {
                    // Actualizar campos ocultos
                    document.getElementById('conductor-id-reporte').value = chofer.id;
                    document.getElementById('conductor-nombre-reporte').value = chofer.nombre;
                    
                    // Mostrar conductor seleccionado
                    document.getElementById('conductor-nombre-reporte-display').textContent = chofer.nombre;
                    document.getElementById('conductor-selected-reporte').classList.remove('hidden');
                    
                    // Limpiar y ocultar búsqueda
                    document.getElementById('resultados-conductor-reporte').classList.add('hidden');
                    document.getElementById('buscar-conductor-reporte').value = '';
                    
                    // Ocultar resultados anteriores del reporte
                    document.getElementById('reporte-conductor-resultados').classList.add('hidden');
                });
                resultadosElement.appendChild(item);
            });

            resultadosElement.classList.remove('hidden');
        }

        function limpiarFiltrosConductor() {
            document.getElementById('buscar-conductor-reporte').value = '';
            document.getElementById('conductor-id-reporte').value = '';
            document.getElementById('conductor-nombre-reporte').value = '';
            document.getElementById('conductor-nombre-reporte-display').textContent = '';
            document.getElementById('conductor-selected-reporte').classList.add('hidden');
            document.getElementById('fecha-inicio-conductor').value = '';
            document.getElementById('fecha-fin-conductor').value = '';
            document.getElementById('resultados-conductor-reporte').classList.add('hidden');
            document.getElementById('reporte-conductor-resultados').classList.add('hidden');
        }

        // Función para generar reporte por unidad
        async function generarReportePorUnidad() {
            const numeroUnidad = document.getElementById('numero-unidad-reporte').value;
            const fechaInicio = document.getElementById('fecha-inicio-unidad').value;
            const fechaFin = document.getElementById('fecha-fin-unidad').value;

            if (!numeroUnidad) {
                alert('Por favor, ingresa el número de unidad');
                return;
            }

            if (numeroUnidad < 1 || numeroUnidad > 200) {
                alert('El número de unidad debe estar entre 1 y 200');
                return;
            }

            if (!fechaInicio || !fechaFin) {
                alert('Por favor, selecciona el rango de fechas');
                return;
            }

            if (new Date(fechaInicio) > new Date(fechaFin)) {
                alert('La fecha de inicio no puede ser posterior a la fecha de fin');
                return;
            }

            try {
                const data = await apiCall('registros.php');
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar registros');
                }

                // Filtrar registros por unidad y rango de fechas
                const registrosFiltrados = data.data.filter(registro => {
                    // Usar comparación directa de strings para evitar problemas de timezone
                    const fechaRegistro = registro.fecha;
                    
                    const dentroDeFechas = fechaRegistro >= fechaInicio && fechaRegistro <= fechaFin;
                    const esLaUnidad = parseInt(registro.unidad) === parseInt(numeroUnidad);
                    
                    return dentroDeFechas && esLaUnidad;
                });

                mostrarReportePorUnidad(registrosFiltrados, numeroUnidad, fechaInicio, fechaFin);
            } catch (error) {
                alert('Error al generar el reporte por unidad: ' + error.message);
            }
        }

        function mostrarReportePorUnidad(registros, numeroUnidad, fechaInicio, fechaFin) {
            const tabla = document.getElementById('tabla-reporte-unidad');
            tabla.innerHTML = '';

            let totalRegistros = registros.length;
            let totalTurnos = 0;
            let totalHoras = 0;
            let diasOperados = new Set();

            if (registros.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td colspan="8" class="py-3 px-4 border-b text-center text-gray-500">
                        No se encontraron registros para esta unidad en el rango de fechas seleccionado
                    </td>
                `;
                tabla.appendChild(fila);
            } else {
                // Ordenar registros por fecha (usando comparación de strings)
                registros.sort((a, b) => a.fecha.localeCompare(b.fecha));

                registros.forEach(registro => {
                    diasOperados.add(registro.fecha);
                    
                    const fila = document.createElement('tr');
                    
                    // Calcular información de turnos y horas
                    let conductorTurno1 = registro.chofer1Nombre || '-';
                    let horasTurno1 = 0;
                    let conductorTurno2 = registro.chofer2Nombre || '-';
                    let horasTurno2 = 0;
                    let turnosDelDia = registro.turnos || 0;
                    let horasDelDia = registro.horas || 0;

                    // Calcular horas por turno individualmente
                    if (registro.salida1 && registro.llegada1) {
                        horasTurno1 = calcularHorasEntreTiempos(registro.salida1, registro.llegada1);
                    }
                    
                    if (registro.salida2 && registro.llegada2) {
                        horasTurno2 = calcularHorasEntreTiempos(registro.salida2, registro.llegada2);
                    }

                    // Caso especial: doble turno
                    if (registro.salida1 && !registro.llegada1 && !registro.salida2 && registro.llegada2) {
                        conductorTurno1 = registro.chofer1Nombre || '-';
                        horasTurno1 = calcularHorasEntreTiempos(registro.salida1, registro.llegada2);
                        conductorTurno2 = 'Doble turno';
                        horasTurno2 = 0;
                    }

                    totalTurnos += turnosDelDia;
                    totalHoras += horasDelDia;

                    let estadoBadge = '';
                    if (registro.incompleto) {
                        estadoBadge = '<span class="px-2 py-1 badge-incompleto rounded-full text-xs font-medium">Incompleto</span>';
                        fila.classList.add('bg-yellow-50');
                    } else {
                        estadoBadge = '<span class="px-2 py-1 badge-completo rounded-full text-xs font-medium">Completo</span>';
                    }
                    
                    fila.innerHTML = `
                        <td class="py-3 px-4 border-b">${formatearFecha(registro.fecha)}</td>
                        <td class="py-3 px-4 border-b">${conductorTurno1}</td>
                        <td class="py-3 px-4 border-b">${horasTurno1.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">${conductorTurno2}</td>
                        <td class="py-3 px-4 border-b">${horasTurno2.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">${turnosDelDia}</td>
                        <td class="py-3 px-4 border-b">${horasDelDia.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">${estadoBadge}</td>
                    `;
                    
                    tabla.appendChild(fila);
                });
            }

            // Actualizar resumen
            document.getElementById('resumen-unidad-numero').textContent = numeroUnidad;
            document.getElementById('resumen-total-registros').textContent = totalRegistros;
            document.getElementById('resumen-total-turnos-unidad').textContent = totalTurnos;
            document.getElementById('resumen-total-horas-unidad').textContent = totalHoras.toFixed(2);
            document.getElementById('resumen-dias-operados').textContent = diasOperados.size;

            // Mostrar resultados
            document.getElementById('reporte-unidad-resultados').classList.remove('hidden');
        }

        function limpiarFiltrosUnidad() {
            document.getElementById('numero-unidad-reporte').value = '';
            document.getElementById('fecha-inicio-unidad').value = '';
            document.getElementById('fecha-fin-unidad').value = '';
            document.getElementById('reporte-unidad-resultados').classList.add('hidden');
        }

        // Funciones para manejo de tema
        function initTheme() {
            // Verificar si hay un tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Usar tema guardado o preferencia del sistema
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            
            setTheme(theme);
        }

        function setTheme(theme) {
            const body = document.body;
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            
            if (theme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
                
                // Forzar estilos para el panel de resumen inmediatamente y con observer
                applyDarkThemeToResumen();
                
                // Observer para aplicar estilos cuando aparezcan nuevos elementos
                const observer = new MutationObserver(() => {
                    applyDarkThemeToResumen();
                });
                observer.observe(document.body, { childList: true, subtree: true });
                
            } else {
                body.removeAttribute('data-theme');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
                
                // Remover estilos forzados en modo claro
                removeDarkThemeFromResumen();
            }
            
            // Guardar preferencia
            localStorage.setItem('theme', theme);
        }

        function applyDarkThemeToResumen() {
            // Aplicar estilos a elementos bg-gray-100
            const resumenDivs = document.querySelectorAll('.bg-gray-100');
            resumenDivs.forEach(div => {
                div.style.setProperty('background-color', '#374151', 'important');
                div.style.setProperty('color', '#ffffff', 'important');
                div.style.setProperty('border', '1px solid #4b5563', 'important');
                
                // Aplicar a todos los elementos hijos también
                const allChildren = div.querySelectorAll('*');
                allChildren.forEach(child => {
                    child.style.setProperty('color', '#ffffff', 'important');
                });
            });

            // Aplicar estilos a operadores seleccionados (bg-blue-50)
            const operadorDivs = document.querySelectorAll('.bg-blue-50');
            operadorDivs.forEach(div => {
                div.style.setProperty('background-color', '#1e3a8a', 'important');
                div.style.setProperty('border-color', '#3b82f6', 'important');
                
                const spans = div.querySelectorAll('span');
                spans.forEach(span => {
                    span.style.setProperty('color', '#ffffff', 'important');
                });
                
                const buttons = div.querySelectorAll('button');
                buttons.forEach(button => {
                    button.style.setProperty('color', '#d1d5db', 'important');
                });
            });
        }

        function removeDarkThemeFromResumen() {
            // Remover estilos de elementos bg-gray-100
            const resumenDivs = document.querySelectorAll('.bg-gray-100');
            resumenDivs.forEach(div => {
                div.style.removeProperty('background-color');
                div.style.removeProperty('color');
                div.style.removeProperty('border');
                
                const allChildren = div.querySelectorAll('*');
                allChildren.forEach(child => {
                    child.style.removeProperty('color');
                });
            });

            // Remover estilos de operadores seleccionados (bg-blue-50)
            const operadorDivs = document.querySelectorAll('.bg-blue-50');
            operadorDivs.forEach(div => {
                div.style.removeProperty('background-color');
                div.style.removeProperty('border-color');
                
                const spans = div.querySelectorAll('span');
                spans.forEach(span => {
                    span.style.removeProperty('color');
                });
                
                const buttons = div.querySelectorAll('button');
                buttons.forEach(button => {
                    button.style.removeProperty('color');
                });
            });
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        // Función de logout
        async function logout() {
            try {
                const token = getSessionToken();
                if (token) {
                    // Intentar logout en el servidor
                    const response = await fetch('./api/auth-simple.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            action: 'logout'
                        })
                    });
                    
                    // No importa si falla, igual limpiamos local
                    if (response.ok) {
                        console.log('Logout exitoso en servidor');
                    }
                }
            } catch (error) {
                console.log('Error en logout servidor:', error);
                // No importa el error, igual limpiamos local
            } finally {
                // Limpiar datos locales
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_data');
                
                // Redireccionar al login
                window.location.href = 'login.html';
            }
        }

        // Función para verificar autenticación al inicio
        async function verifyAuth() {
            const token = getSessionToken();
            
            if (!token) {
                window.location.href = 'login.html?from=index';
                return false;
            }
            
            try {
                const response = await fetch('./api/auth-simple.php?action=verify', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Token inválido');
                }
                
                // Actualizar información del usuario en la interfaz
                if (data.user) {
                    document.getElementById('user-name').textContent = data.user.name || data.user.username;
                    // Guardar datos del usuario
                    localStorage.setItem('user_data', JSON.stringify(data.user));
                    
                    // Mostrar botón de administración si es admin
                    if (data.user.role === 'admin') {
                        document.getElementById('admin-btn').classList.remove('hidden');
                    }

                    aplicarPermisosPorRol(data.user);
                }
                
                return true;
                
            } catch (error) {
                console.error('Error verificando autenticación:', error);
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_data');
                window.location.href = 'login.html?from=index';
                return false;
            }
        }

        // Eventos de la interfaz
        document.addEventListener('DOMContentLoaded', async function () {
            // Verificar autenticación primero
            const isAuthenticated = await verifyAuth();
            if (!isAuthenticated) {
                return; // Si no está autenticado, se redirige automáticamente
            }

            // Inicializar tema
            initTheme();

            // Event listener para el botón de tema
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // Event listener para logout
            document.getElementById('logout-button').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                    logout();
                }
            });

            // Event listener para el botón de administración
            document.getElementById('admin-btn').addEventListener('click', function() {
                window.open('admin-security.html', '_blank');
            });

            // Establecer fecha actual en el buscador
            const today = new Date();
            const fechaActual = today.getFullYear() + '-' + 
                String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                String(today.getDate()).padStart(2, '0');
            document.getElementById('search-fecha').value = fechaActual;

            // Inicializar base de datos
            inicializarDB();

            // Eventos de pestañas
            document.getElementById('tab-control').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-control').classList.remove('hidden');

                document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
            });

            document.getElementById('tab-unidades').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-unidades').classList.remove('hidden');

                document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');

                // Cargar tabla de unidades al cambiar a esta pestaña
                cargarTablaUnidades();
            });

            document.getElementById('tab-choferes').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-choferes').classList.remove('hidden');

                document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
            });

            document.getElementById('tab-reportes').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-reportes').classList.remove('hidden');

                document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
            });

            document.getElementById('tab-chat').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-chat').classList.remove('hidden');

                document.querySelectorAll('button[id^="tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
            });

            // Eventos del menú móvil
            document.getElementById('mobile-menu-toggle').addEventListener('click', function () {
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = this.querySelector('svg');
                
                mobileMenu.classList.toggle('hidden');
                hamburgerIcon.classList.toggle('active');
            });

            // Eventos de pestañas móviles
            document.getElementById('mobile-tab-control').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-control').classList.remove('hidden');

                // Actualizar estado activo en ambos menús
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
                document.getElementById('tab-control').classList.add('tab-active');
                
                // Ocultar menú móvil y resetear icono
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = document.getElementById('mobile-menu-toggle').querySelector('svg');
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            document.getElementById('mobile-tab-unidades').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-unidades').classList.remove('hidden');

                // Actualizar estado activo en ambos menús
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
                document.getElementById('tab-unidades').classList.add('tab-active');

                // Cargar tabla de unidades al cambiar a esta pestaña
                cargarTablaUnidades();
                
                // Ocultar menú móvil y resetear icono
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = document.getElementById('mobile-menu-toggle').querySelector('svg');
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            document.getElementById('mobile-tab-choferes').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-choferes').classList.remove('hidden');

                // Actualizar estado activo en ambos menús
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
                document.getElementById('tab-choferes').classList.add('tab-active');
                
                // Ocultar menú móvil y resetear icono
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = document.getElementById('mobile-menu-toggle').querySelector('svg');
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            document.getElementById('mobile-tab-reportes').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-reportes').classList.remove('hidden');

                // Actualizar estado activo en ambos menús
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
                document.getElementById('tab-reportes').classList.add('tab-active');
                
                // Ocultar menú móvil y resetear icono
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = document.getElementById('mobile-menu-toggle').querySelector('svg');
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            document.getElementById('mobile-tab-chat').addEventListener('click', function () {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('content-chat').classList.remove('hidden');

                // Actualizar estado activo en ambos menús
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
                this.classList.add('tab-active');
                document.getElementById('tab-chat').classList.add('tab-active');
                
                // Ocultar menú móvil y resetear icono
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerIcon = document.getElementById('mobile-menu-toggle').querySelector('svg');
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            // Cerrar menú móvil al hacer clic fuera de él
            document.addEventListener('click', function (e) {
                const mobileMenu = document.getElementById('mobile-menu');
                const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                const hamburgerIcon = mobileMenuToggle.querySelector('svg');
                
                if (!mobileMenu.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                    hamburgerIcon.classList.remove('active');
                }
            });

            // Cerrar menú móvil al hacer scroll
            window.addEventListener('scroll', function () {
                const mobileMenu = document.getElementById('mobile-menu');
                const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                const hamburgerIcon = mobileMenuToggle.querySelector('svg');
                
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('active');
            });

            // Función para sincronizar el estado activo entre menús móvil y desktop
            function syncTabState(activeTabId) {
                document.querySelectorAll('button[id^="tab-"], button[id^="mobile-tab-"]').forEach(btn => {
                    btn.classList.remove('tab-active');
                });
                
                // Activar tab en menú desktop
                document.getElementById(activeTabId).classList.add('tab-active');
                
                // Activar tab correspondiente en menú móvil
                const mobileTabId = 'mobile-' + activeTabId;
                const mobileTab = document.getElementById(mobileTabId);
                if (mobileTab) {
                    mobileTab.classList.add('tab-active');
                }
            }

            // Eventos de control de unidades
            document.getElementById('form-buscar-unidad').addEventListener('submit', function (e) {
                e.preventDefault();
                buscarUnidad();
            });

            document.getElementById('btn-guardar').addEventListener('click', guardarRegistro);
            document.getElementById('btn-nuevo-registro').addEventListener('click', crearNuevoRegistroActual);
            document.getElementById('btn-cancelar').addEventListener('click', function () {
                document.getElementById('unidad-details').classList.add('hidden');
            });

            // Eventos para calcular turnos y horas automáticamente
            ['salida1', 'llegada1', 'salida2', 'llegada2'].forEach(id => {
                document.getElementById(id).addEventListener('change', calcularTurnosYHoras);
            });

            // Eventos de búsqueda de choferes
            document.getElementById('chofer1-search').addEventListener('input', function () {
                buscarChoferes(this.value, 'chofer1-results', 'chofer1-id', 'chofer1-nombre', 'chofer1-selected');
            });

            document.getElementById('chofer2-search').addEventListener('input', function () {
                buscarChoferes(this.value, 'chofer2-results', 'chofer2-id', 'chofer2-nombre', 'chofer2-selected');
            });

            // Eventos para limpiar choferes seleccionados
            document.getElementById('chofer1-clear').addEventListener('click', function () {
                document.getElementById('chofer1-id').value = '';
                document.getElementById('chofer1-selected').classList.add('hidden');
                calcularTurnosYHoras();
            });

            document.getElementById('chofer2-clear').addEventListener('click', function () {
                document.getElementById('chofer2-id').value = '';
                document.getElementById('chofer2-selected').classList.add('hidden');
                calcularTurnosYHoras();
            });

            // Evento para actualizar el badge de estado cuando se marca como incompleto
            document.getElementById('marcar-incompleto').addEventListener('change', function () {
                const estadoBadge = document.getElementById('estado-registro-badge');
                estadoBadge.classList.remove('hidden', 'badge-completo', 'badge-incompleto');

                if (this.checked) {
                    estadoBadge.classList.add('badge-incompleto');
                    estadoBadge.textContent = 'Reporte Incompleto';
                } else {
                    estadoBadge.classList.add('badge-completo');
                    estadoBadge.textContent = 'Reporte Completo';
                }
            });

            // Ocultar resultados de búsqueda al hacer clic fuera
            document.addEventListener('click', function (event) {
                if (!event.target.closest('#chofer1-search') && !event.target.closest('#chofer1-results')) {
                    document.getElementById('chofer1-results').classList.add('hidden');
                }

                if (!event.target.closest('#chofer2-search') && !event.target.closest('#chofer2-results')) {
                    document.getElementById('chofer2-results').classList.add('hidden');
                }
            });

            // Eventos de gestión de choferes
            document.getElementById('btn-agregar-chofer').addEventListener('click', agregarChofer);

            // Eventos de tabla de unidades - filtrado automático
            document.getElementById('fecha-tabla-unidades').addEventListener('change', cargarTablaUnidades);
            document.getElementById('filtro-unidades').addEventListener('change', cargarTablaUnidades);

            // Eventos de reportes
            document.getElementById('btn-generar-reporte-diario').addEventListener('click', generarReporteDiario);
            document.getElementById('btn-generar-reporte-mensual').addEventListener('click', generarReporteMensual);
            document.getElementById('btn-generar-reporte-conductor').addEventListener('click', generarReportePorConductor);
            document.getElementById('btn-limpiar-conductor').addEventListener('click', limpiarFiltrosConductor);
            document.getElementById('btn-generar-reporte-unidad').addEventListener('click', generarReportePorUnidad);
            document.getElementById('btn-limpiar-unidad').addEventListener('click', limpiarFiltrosUnidad);

            // Búsqueda de conductor para reportes
            document.getElementById('buscar-conductor-reporte').addEventListener('input', function (e) {
                const searchTerm = e.target.value;
                buscarChoferesReporte(searchTerm);
            });

            // Evento para limpiar conductor seleccionado
            document.getElementById('conductor-clear-reporte').addEventListener('click', function () {
                document.getElementById('conductor-id-reporte').value = '';
                document.getElementById('conductor-nombre-reporte').value = '';
                document.getElementById('conductor-nombre-reporte-display').textContent = '';
                document.getElementById('conductor-selected-reporte').classList.add('hidden');
                document.getElementById('buscar-conductor-reporte').value = '';
                document.getElementById('reporte-conductor-resultados').classList.add('hidden');
            });

            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#buscar-conductor-reporte') && !e.target.closest('#resultados-conductor-reporte')) {
                    document.getElementById('resultados-conductor-reporte').classList.add('hidden');
                }
            });

            // Eventos del modal de confirmación
            document.getElementById('btn-cancelar-eliminar').addEventListener('click', function () {
                document.getElementById('modal-confirmacion').classList.add('hidden');
                registroAEliminar = null;
            });

            document.getElementById('btn-confirmar-eliminar').addEventListener('click', eliminarRegistro);
        });

        
function editarChofer(id, nombre) {
    document.getElementById('id-chofer-edicion').value = id;
    document.getElementById('nombre-chofer').value = nombre;
    document.getElementById('texto-boton-chofer').textContent = 'Guardar Cambios';
}

async function guardarChofer() {
    const nombre = document.getElementById('nombre-chofer').value.trim();
    const idEdicion = document.getElementById('id-chofer-edicion').value;

    if (!nombre) {
        alert('Por favor, ingresa el nombre del Operador');
        return;
    }

    try {
        if (idEdicion) {
            // Editar operador existente
            console.log('Editando chofer:', idEdicion, nombre);
            await apiCall(`choferes.php?id=${idEdicion}`, 'PUT', { nombre: nombre });
            alert('Operador actualizado correctamente');
        } else {
            // Agregar nuevo operador
            console.log('Agregando nuevo chofer:', nombre);
            await apiCall('choferes.php', 'POST', { nombre: nombre });
            alert('Operador agregado correctamente');
        }
        
        limpiarFormularioChofer();
        await cargarChoferes();
        
    } catch (error) {
        console.error('Error al guardar chofer:', error);
        alert('Error al guardar el operador: ' + error.message);
    }
}

function limpiarFormularioChofer() {
    document.getElementById('nombre-chofer').value = '';
    document.getElementById('id-chofer-edicion').value = '';
    document.getElementById('texto-boton-chofer').textContent = 'Agregar Operador';
}


        // =======================
        // EXPORTACIÓN DE REPORTES
        // =======================

        // Exportar reporte diario a PDF
        document.getElementById("btn-descargar-reporte-diario-pdf").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-diario");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const doc = new jspdf.jsPDF();
            doc.text("Reporte Diario", 14, 10);

            const data = Array.from(rows).map(row =>
                Array.from(row.cells).map(cell => cell.innerText.trim())
            );

            const headers = ["Unidad", "Estado", "Operador", "Turnos", "Horas"];
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 20
            });

            doc.save("reporte_diario.pdf");
        });

        // Exportar reporte diario a CSV
        document.getElementById("btn-descargar-reporte-diario-csv").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-diario");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            let csv = "Unidad,Estado,Operador,Turnos,Horas\n";
            rows.forEach(row => {
                const rowData = Array.from(row.cells).map(cell => `"${cell.innerText.trim()}"`).join(",");
                csv += rowData + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            saveAs(blob, "reporte_diario.csv");
        });

        // Exportar reporte mensual a PDF
        document.getElementById("btn-descargar-reporte-mensual-pdf").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-mensual");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const doc = new jspdf.jsPDF();
            doc.text("Reporte Mensual", 14, 10);

            const data = Array.from(rows).map(row =>
                Array.from(row.cells).map(cell => cell.innerText.trim())
            );

            const headers = ["Unidad", "Estado", "Total Turnos", "Total Horas", "Reportes Incompletos"];
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 20
            });

            doc.save("reporte_mensual.pdf");
        });

        // Exportar reporte mensual a CSV
        document.getElementById("btn-descargar-reporte-mensual-csv").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-mensual");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            let csv = "Unidad,Estado,Total Turnos,Total Horas,Reportes Incompletos\n";
            rows.forEach(row => {
                const rowData = Array.from(row.cells).map(cell => `"${cell.innerText.trim()}"`).join(",");
                csv += rowData + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            saveAs(blob, "reporte_mensual.csv");
        });

        // Exportar reporte por conductor a PDF
        document.getElementById("btn-descargar-reporte-conductor-pdf").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-conductor");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Título del reporte
            const conductorNombre = document.getElementById('resumen-conductor-nombre').textContent;
            const fechaInicio = document.getElementById('fecha-inicio-conductor').value;
            const fechaFin = document.getElementById('fecha-fin-conductor').value;
            
            doc.setFontSize(18);
            doc.text("Reporte por Conductor", 14, 20);
            
            doc.setFontSize(12);
            doc.text(`Conductor: ${conductorNombre}`, 14, 35);
            doc.text(`Período: ${formatearFecha(fechaInicio)} - ${formatearFecha(fechaFin)}`, 14, 45);

            // Resumen
            const totalTurnos = document.getElementById('resumen-total-turnos').textContent;
            const totalHoras = document.getElementById('resumen-total-horas').textContent;
            const diasTrabajados = document.getElementById('resumen-dias-trabajados').textContent;
            
            doc.text(`Total Turnos: ${totalTurnos}`, 14, 60);
            doc.text(`Total Horas: ${totalHoras}`, 80, 60);
            doc.text(`Días Trabajados: ${diasTrabajados}`, 140, 60);

            // Tabla de datos
            const tableData = [];
            const headers = ["Fecha", "Unidad", "Turno", "Hora Inicio", "Hora Fin", "Horas", "Estado"];
            
            rows.forEach(row => {
                const rowData = [];
                row.cells.forEach(cell => {
                    // Limpiar texto de badges HTML
                    let cellText = cell.innerText.trim();
                    rowData.push(cellText);
                });
                if (rowData.some(cell => cell !== "")) {
                    tableData.push(rowData);
                }
            });

            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 75,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save(`reporte_conductor_${conductorNombre.replace(/\s+/g, '_')}.pdf`);
        });

        // Exportar reporte por conductor a CSV
        document.getElementById("btn-descargar-reporte-conductor-csv").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-conductor");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const conductorNombre = document.getElementById('resumen-conductor-nombre').textContent;
            let csv = "Fecha,Unidad,Turno,Hora Inicio,Hora Fin,Horas Trabajadas,Estado\n";
            
            rows.forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    // Limpiar texto de badges HTML
                    let cellText = cell.innerText.trim();
                    return `"${cellText}"`;
                }).join(",");
                csv += rowData + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            saveAs(blob, `reporte_conductor_${conductorNombre.replace(/\s+/g, '_')}.csv`);
        });

        // Exportar reporte por unidad a PDF
        document.getElementById("btn-descargar-reporte-unidad-pdf").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-unidad");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Título del reporte
            const numeroUnidad = document.getElementById('resumen-unidad-numero').textContent;
            const fechaInicio = document.getElementById('fecha-inicio-unidad').value;
            const fechaFin = document.getElementById('fecha-fin-unidad').value;
            
            doc.setFontSize(18);
            doc.text("Reporte por Unidad", 14, 20);
            
            doc.setFontSize(12);
            doc.text(`Unidad: ${numeroUnidad}`, 14, 35);
            doc.text(`Período: ${formatearFecha(fechaInicio)} - ${formatearFecha(fechaFin)}`, 14, 45);

            // Resumen
            const totalRegistros = document.getElementById('resumen-total-registros').textContent;
            const totalTurnos = document.getElementById('resumen-total-turnos-unidad').textContent;
            const totalHoras = document.getElementById('resumen-total-horas-unidad').textContent;
            const diasOperados = document.getElementById('resumen-dias-operados').textContent;
            
            doc.text(`Total Registros: ${totalRegistros}`, 14, 60);
            doc.text(`Total Turnos: ${totalTurnos}`, 70, 60);
            doc.text(`Total Horas: ${totalHoras}`, 120, 60);
            doc.text(`Días Operados: ${diasOperados}`, 14, 70);

            // Tabla de datos
            const tableData = [];
            const headers = ["Fecha", "Conductor T1", "Horas T1", "Conductor T2", "Horas T2", "Tot. Turnos", "Tot. Horas", "Estado"];
            
            rows.forEach(row => {
                const rowData = [];
                row.cells.forEach(cell => {
                    // Limpiar texto de badges HTML
                    let cellText = cell.innerText.trim();
                    rowData.push(cellText);
                });
                if (rowData.some(cell => cell !== "")) {
                    tableData.push(rowData);
                }
            });

            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 80,
                styles: { fontSize: 7 },
                headStyles: { fillColor: [34, 197, 94] }
            });

            doc.save(`reporte_unidad_${numeroUnidad}.pdf`);
        });

        // Exportar reporte por unidad a CSV
        document.getElementById("btn-descargar-reporte-unidad-csv").addEventListener("click", () => {
            const table = document.querySelector("#tabla-reporte-unidad");
            const rows = table.querySelectorAll("tbody tr");

            const hasData = Array.from(rows).some(row =>
                Array.from(row.cells).some(cell => cell.innerText.trim() !== "")
            );

            if (!hasData) {
                alert("No hay datos para exportar.");
                return;
            }

            const numeroUnidad = document.getElementById('resumen-unidad-numero').textContent;
            let csv = "Fecha,Conductor Turno 1,Horas Turno 1,Conductor Turno 2,Horas Turno 2,Total Turnos,Total Horas,Estado\n";
            
            rows.forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    // Limpiar texto de badges HTML
                    let cellText = cell.innerText.trim();
                    return `"${cellText}"`;
                }).join(",");
                csv += rowData + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            saveAs(blob, `reporte_unidad_${numeroUnidad}.csv`);
        });


        // Función global para eliminar chofer (para usar en onclick)
        window.eliminarChofer = eliminarChofer;

        // Función global para editar registro (para usar en onclick)
        window.editarRegistro = editarRegistro;

        // Función global para confirmar eliminación de registro (para usar en onclick)
        window.confirmarEliminarRegistro = confirmarEliminarRegistro;

        // Funciones globales para la tabla de unidades
        window.editarRegistroDesdeTabla = editarRegistroDesdeTabla;
        window.crearRegistroDesdeTabla = crearRegistroDesdeTabla;

        // Variables globales del chatbot
        let chatInput, chatEnviar, chatMensajes;

        // Función para formatear turnos de manera simple
        function formatearTurnosSimple(registro) {
            let texto = '';
            
            // Caso especial: turno completo (mismo chofer, sin chofer2, salida1 y llegada2)
            if (registro.chofer1Nombre && registro.chofer1Nombre.trim() && 
                !registro.chofer2Nombre && registro.salida1 && registro.llegada2) {
                
                return `${registro.chofer1Nombre} de ${registro.salida1} a ${registro.llegada2} (turno completo)`;
            }
            
            // Turno 1 (mañana) - usar chofer1Nombre
            const tieneChofer1 = registro.chofer1Nombre && registro.chofer1Nombre.trim() !== '';
            const tieneChofer2 = registro.chofer2Nombre && registro.chofer2Nombre.trim() !== '';
            
            if (tieneChofer1) {
                let horario1 = '';
                if (registro.salida1 && registro.llegada1) {
                    horario1 = ` de ${registro.salida1} a ${registro.llegada1}`;
                } else if (registro.salida1) {
                    horario1 = ` desde las ${registro.salida1}`;
                } else if (registro.llegada1) {
                    horario1 = ` hasta las ${registro.llegada1}`;
                } else {
                    horario1 = ' (turno mañana)';
                }
                
                texto += `${registro.chofer1Nombre}${horario1}`;
                if (tieneChofer2) {
                    texto += ', ';
                }
            }
            
            // Turno 2 (noche) - usar chofer2Nombre
            if (tieneChofer2) {
                let horario2 = '';
                if (registro.salida2 && registro.llegada2) {
                    horario2 = ` de ${registro.salida2} a ${registro.llegada2}`;
                } else if (registro.salida2) {
                    horario2 = ` desde las ${registro.salida2}`;
                } else if (registro.llegada2) {
                    horario2 = ` hasta las ${registro.llegada2}`;
                } else {
                    horario2 = ' (turno noche)';
                }
                
                texto += `${registro.chofer2Nombre}${horario2}`;
            }
            
            // Si no hay ningún turno
            if (!tieneChofer1 && !tieneChofer2) {
                texto = 'No trabajó nadie ese día';
            }
            
            return texto;
        }

        // Función para que el LLM analice la consulta y genere un plan de búsqueda
        async function analizarConsultaConIA(mensaje) {
            try {
                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    throw new Error('API Key de OpenAI no configurada');
                }
                
                const prompt = `Analiza esta consulta sobre turnos de mototaxis y genera un plan de búsqueda JSON:

CONSULTA DEL USUARIO: "${mensaje}"

INFORMACIÓN DEL SISTEMA:
- 200 unidades numeradas del 1 al 200
- Base de datos con registros que incluyen: fecha, unidad, chofer1Nombre, chofer2Nombre, salida1, llegada1, salida2, llegada2
- Fecha actual: ${getFechaLocalISO()}

TIPOS DE ANÁLISIS POSIBLES:
1. "turnos_por_fecha" - Mostrar turnos de una fecha específica
2. "turnos_por_unidad" - Mostrar turnos de una unidad específica
3. "estadisticas_chofer" - Analizar qué chofer trabajó más
4. "estadisticas_unidad" - Analizar qué unidades trabajaron más
5. "primer_turno_dia" - Encontrar quién empezó primero un día
6. "analisis_periodo" - Análisis complejo de un período

Responde SOLO con un JSON válido con esta estructura:
{
  "tipo_analisis": "uno de los tipos de arriba",
  "periodo": {
    "fecha_inicio": "YYYY-MM-DD o null",
    "fecha_fin": "YYYY-MM-DD o null",
    "descripcion": "descripción del período"
  },
  "filtros": {
    "unidades": [números de unidades específicas o null],
    "choferes": ["nombres específicos o null"]
  },
  "objetivo": "descripción clara de qué buscar",
  "orden": "asc o desc para ordenamiento"
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.1,
                        max_tokens: 500
                    })
                });
                
                const data = await response.json();
                const planTexto = data.choices[0].message.content.trim();
                
                // Limpiar el texto para extraer solo el JSON
                const jsonMatch = planTexto.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const plan = JSON.parse(jsonMatch[0]);
                    console.log('📋 Plan de consulta generado por IA:', plan);
                    return plan;
                } else {
                    throw new Error('No se pudo extraer JSON válido de la respuesta');
                }
                
            } catch (error) {
                console.error('Error analizando consulta con IA:', error);
                // Fallback al análisis manual básico
                return analizarConsultaManual(mensaje);
            }
        }

        // Función de fallback para análisis manual básico
        function analizarConsultaManual(mensaje) {
            const mensajeLower = mensaje.toLowerCase();
            
            // Análisis básico de fechas
            let fechaInicio = null;
            let fechaFin = null;
            
            if (mensajeLower.includes('hoy')) {
                fechaInicio = fechaFin = getFechaLocalISO();
            } else if (mensajeLower.includes('ayer')) {
                const ayer = new Date();
                ayer.setDate(ayer.getDate() - 1);
                fechaInicio = fechaFin = ayer.toISOString().split('T')[0];
            } else if (mensajeLower.includes('este mes')) {
                const hoy = new Date();
                fechaInicio = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-01`;
                fechaFin = getFechaLocalISO();
            }
            
            // Detectar números de unidad
            const unidadPattern = /unidad\s*(\d+)/gi;
            const unidadMatches = mensaje.match(unidadPattern);
            let unidades = null;
            if (unidadMatches) {
                unidades = unidadMatches.map(match => {
                    const numero = match.match(/(\d+)/);
                    return numero ? parseInt(numero[1]) : null;
                }).filter(num => num !== null && num >= 1 && num <= 200);
            }
            
            // Detectar nombres de choferes comunes
            const nombresComunes = ['sergio', 'pedro', 'juan', 'carlos', 'eduardo', 'miguel', 'jose', 'luis', 'mario', 'alberto'];
            let choferDetectado = null;
            for (const nombre of nombresComunes) {
                if (mensajeLower.includes(nombre)) {
                    choferDetectado = nombre;
                    break;
                }
            }
            
            // Detectar si pregunta por horas trabajadas
            const consultaHoras = mensajeLower.includes('horas') || mensajeLower.includes('trabajado');
            
            let tipoAnalisis = 'primer_turno_dia';
            if (consultaHoras && choferDetectado) {
                tipoAnalisis = 'estadisticas_chofer';
            } else if (mensajeLower.includes('inicio') || mensajeLower.includes('empez') || mensajeLower.includes('primer')) {
                tipoAnalisis = 'primer_turno_dia';
            }
            
            return {
                tipo_analisis: tipoAnalisis,
                periodo: {
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin,
                    descripcion: 'Consulta básica'
                },
                filtros: {
                    unidades: unidades,
                    choferes: choferDetectado ? [choferDetectado] : null
                },
                objetivo: 'Mostrar turnos',
                orden: 'desc'
            };
        }

        // Función para ejecutar el plan de consulta generado por la IA
        async function ejecutarPlanConsulta(plan) {
            try {
                console.log('🎯 Ejecutando plan:', plan);
                
                const response = await apiCall('registros.php');
                if (!response.success || !response.data) {
                    return 'Error al consultar la base de datos.';
                }
                
                let registros = response.data;
                
                // Aplicar filtros de fecha
                if (plan.periodo.fecha_inicio && plan.periodo.fecha_fin) {
                    registros = registros.filter(registro => 
                        registro.fecha >= plan.periodo.fecha_inicio && 
                        registro.fecha <= plan.periodo.fecha_fin
                    );
                } else if (plan.periodo.fecha_inicio) {
                    registros = registros.filter(registro => 
                        registro.fecha >= plan.periodo.fecha_inicio
                    );
                } else if (plan.periodo.fecha_fin) {
                    registros = registros.filter(registro => 
                        registro.fecha <= plan.periodo.fecha_fin
                    );
                }
                
                // Aplicar filtros de unidades
                if (plan.filtros.unidades && plan.filtros.unidades.length > 0) {
                    registros = registros.filter(registro => 
                        plan.filtros.unidades.includes(registro.unidad)
                    );
                }
                
                // Aplicar filtros de choferes
                if (plan.filtros.choferes && plan.filtros.choferes.length > 0) {
                    registros = registros.filter(registro => 
                        plan.filtros.choferes.some(chofer => 
                            (registro.chofer1Nombre && registro.chofer1Nombre.toLowerCase().includes(chofer.toLowerCase())) ||
                            (registro.chofer2Nombre && registro.chofer2Nombre.toLowerCase().includes(chofer.toLowerCase()))
                        )
                    );
                }
                
                console.log(`📊 Registros filtrados: ${registros.length}`);
                
                // Ejecutar análisis según el tipo
                switch (plan.tipo_analisis) {
                    case 'turnos_por_fecha':
                        return analizarTurnosPorFecha(registros, plan);
                        
                    case 'turnos_por_unidad':
                        return analizarTurnosPorUnidad(registros, plan);
                        
                    case 'estadisticas_chofer':
                        return analizarEstadisticasChofer(registros, plan);
                        
                    case 'estadisticas_unidad':
                        return analizarEstadisticasUnidad(registros, plan);
                        
                    case 'primer_turno_dia':
                        return analizarPrimerTurno(registros, plan);
                        
                    case 'analisis_periodo':
                        return analizarPeriodoComplejo(registros, plan);
                        
                    default:
                        return analizarTurnosPorFecha(registros, plan);
                }
                
            } catch (error) {
                console.error('Error ejecutando plan:', error);
                return 'Error al procesar la consulta.';
            }
        }

        // Funciones de análisis específicas
        function analizarTurnosPorFecha(registros, plan) {
            if (registros.length === 0) {
                return `No se encontraron registros para ${plan.periodo.descripcion}.`;
            }
            
            let resultado = `TURNOS ${plan.periodo.descripcion.toUpperCase()}:\n`;
            registros.forEach(registro => {
                const turnoTexto = formatearTurnosSimple(registro);
                resultado += `Unidad ${registro.unidad}: ${turnoTexto}\n`;
            });
            
            return resultado;
        }

        function analizarPrimerTurno(registros, plan) {
            const turnosPorFecha = {};
            
            // Función para convertir hora a minutos del día para comparación correcta
            function horaAMinutos(hora, esTurno2 = false) {
                const [horas, minutos] = hora.split(':').map(Number);
                let horasAjustadas = horas;
                
                // Si es turno2 (tarde/noche) y la hora es menor a 12, es PM
                if (esTurno2 && horas < 12) {
                    horasAjustadas = horas + 12;
                }
                
                return horasAjustadas * 60 + minutos;
            }
            
            registros.forEach(registro => {
                if (!turnosPorFecha[registro.fecha]) {
                    turnosPorFecha[registro.fecha] = [];
                }
                
                if (registro.salida1 && registro.chofer1Nombre) {
                    turnosPorFecha[registro.fecha].push({
                        unidad: registro.unidad,
                        chofer: registro.chofer1Nombre,
                        hora: registro.salida1,
                        tipo: 'T1',
                        minutos: horaAMinutos(registro.salida1, false)
                    });
                }
                
                if (registro.salida2 && registro.chofer2Nombre) {
                    turnosPorFecha[registro.fecha].push({
                        unidad: registro.unidad,
                        chofer: registro.chofer2Nombre,
                        hora: registro.salida2,
                        tipo: 'T2',
                        minutos: horaAMinutos(registro.salida2, true)
                    });
                }
            });
            
            let resultado = `PRIMEROS TURNOS ${plan.periodo.descripcion.toUpperCase()}:\n`;
            
            for (const [fecha, turnos] of Object.entries(turnosPorFecha)) {
                if (turnos.length > 0) {
                    // Ordenar por minutos del día en lugar de comparación alfabética
                    turnos.sort((a, b) => a.minutos - b.minutos);
                    const primero = turnos[0];
                    const horaFormateada = primero.tipo === 'T2' && primero.hora.split(':')[0] < 12 
                        ? `${primero.hora} PM` 
                        : primero.hora;
                    resultado += `${fecha}: Unidad ${primero.unidad} - ${primero.chofer} a las ${horaFormateada}\n`;
                }
            }
            
            return resultado;
        }

        function analizarEstadisticasChofer(registros, plan) {
            const conteoChoferes = {};
            const detallesChoferes = {};
            
            // Función para calcular horas trabajadas entre dos horarios
            function calcularHorasTrabajadas(salida, llegada, esTurno2 = false) {
                if (!salida || !llegada) return 0;
                
                const [salidaHoras, salidaMinutos] = salida.split(':').map(Number);
                const [llegadaHoras, llegadaMinutos] = llegada.split(':').map(Number);
                
                let salidaAjustada = salidaHoras;
                let llegadaAjustada = llegadaHoras;
                
                // Si es turno2 (tarde) y la hora de salida es menor a 12, es PM
                if (esTurno2 && salidaHoras < 12) {
                    salidaAjustada = salidaHoras + 12;
                }
                
                // Si la llegada es menor que la salida, es del día siguiente
                if (llegadaAjustada < salidaAjustada) {
                    llegadaAjustada += 24;
                }
                
                const salidaEnMinutos = salidaAjustada * 60 + salidaMinutos;
                const llegadaEnMinutos = llegadaAjustada * 60 + llegadaMinutos;
                
                const minutosTrabajas = llegadaEnMinutos - salidaEnMinutos;
                return minutosTrabajas / 60; // Convertir a horas
            }
            
            registros.forEach(registro => {
                // Caso especial: mismo chofer en ambos turnos (turnos consecutivos)
                if (registro.chofer1Nombre && registro.chofer1Nombre.trim() && 
                    !registro.chofer2Nombre && registro.salida1 && registro.llegada2) {
                    
                    const nombre = registro.chofer1Nombre;
                    conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                    
                    if (!detallesChoferes[nombre]) {
                        detallesChoferes[nombre] = { 
                            unidades: new Set(), 
                            fechas: new Set(),
                            horasTotales: 0,
                            turnos: []
                        };
                    }
                    detallesChoferes[nombre].unidades.add(registro.unidad);
                    detallesChoferes[nombre].fechas.add(registro.fecha);
                    
                    // Calcular desde salida1 hasta llegada2 (turno completo)
                    const [salidaH, salidaM] = registro.salida1.split(':').map(Number);
                    const [llegadaH, llegadaM] = registro.llegada2.split(':').map(Number);
                    
                    let llegadaAjustada = llegadaH;
                    // Si llegada es menor que salida, es del día siguiente
                    if (llegadaH < salidaH) {
                        llegadaAjustada += 24;
                    }
                    
                    const salidaEnMinutos = salidaH * 60 + salidaM;
                    const llegadaEnMinutos = llegadaAjustada * 60 + llegadaM;
                    const horasCompletas = (llegadaEnMinutos - salidaEnMinutos) / 60;
                    
                    detallesChoferes[nombre].horasTotales += horasCompletas;
                    detallesChoferes[nombre].turnos.push({
                        fecha: registro.fecha,
                        unidad: registro.unidad,
                        tipo: 'COMPLETO',
                        salida: registro.salida1,
                        llegada: registro.llegada2,
                        horas: horasCompletas
                    });
                    
                    return; // Salir para no procesar como turnos separados
                }
                
                // Chofer 1 (procesamiento normal)
                if (registro.chofer1Nombre && registro.chofer1Nombre.trim()) {
                    const nombre = registro.chofer1Nombre;
                    conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                    
                    if (!detallesChoferes[nombre]) {
                        detallesChoferes[nombre] = { 
                            unidades: new Set(), 
                            fechas: new Set(),
                            horasTotales: 0,
                            turnos: []
                        };
                    }
                    detallesChoferes[nombre].unidades.add(registro.unidad);
                    detallesChoferes[nombre].fechas.add(registro.fecha);
                    
                    // Calcular horas del turno 1
                    const horasTurno1 = calcularHorasTrabajadas(registro.salida1, registro.llegada1, false);
                    detallesChoferes[nombre].horasTotales += horasTurno1;
                    detallesChoferes[nombre].turnos.push({
                        fecha: registro.fecha,
                        unidad: registro.unidad,
                        tipo: 'T1',
                        salida: registro.salida1,
                        llegada: registro.llegada1,
                        horas: horasTurno1
                    });
                }
                
                // Chofer 2 (procesamiento normal)
                if (registro.chofer2Nombre && registro.chofer2Nombre.trim()) {
                    const nombre = registro.chofer2Nombre;
                    conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                    
                    if (!detallesChoferes[nombre]) {
                        detallesChoferes[nombre] = { 
                            unidades: new Set(), 
                            fechas: new Set(),
                            horasTotales: 0,
                            turnos: []
                        };
                    }
                    detallesChoferes[nombre].unidades.add(registro.unidad);
                    detallesChoferes[nombre].fechas.add(registro.fecha);
                    
                    // Calcular horas del turno 2
                    const horasTurno2 = calcularHorasTrabajadas(registro.salida2, registro.llegada2, true);
                    detallesChoferes[nombre].horasTotales += horasTurno2;
                    detallesChoferes[nombre].turnos.push({
                        fecha: registro.fecha,
                        unidad: registro.unidad,
                        tipo: 'T2',
                        salida: registro.salida2,
                        llegada: registro.llegada2,
                        horas: horasTurno2
                    });
                }
            });
            
            const choferesSorted = Object.entries(conteoChoferes)
                .sort(([,a], [,b]) => plan.orden === 'asc' ? a - b : b - a);
            
            if (choferesSorted.length === 0) {
                return `No se encontraron choferes para ${plan.periodo.descripcion}.`;
            }
            
            let resultado = `ESTADÍSTICAS DE CHOFERES ${plan.periodo.descripcion.toUpperCase()}:\n`;
            choferesSorted.slice(0, 5).forEach(([nombre, turnos], index) => {
                const detalles = detallesChoferes[nombre];
                const unidadesArray = Array.from(detalles.unidades).sort((a, b) => a - b);
                const diasTrabajados = detalles.fechas.size;
                const horasFormateadas = detalles.horasTotales.toFixed(1);
                const promedioHorasPorDia = (detalles.horasTotales / diasTrabajados).toFixed(1);
                
                resultado += `${index + 1}. ${nombre}:\n`;
                resultado += `   • ${turnos} turnos en ${diasTrabajados} días\n`;
                resultado += `   • ${horasFormateadas} horas totales (${promedioHorasPorDia} hrs/día promedio)\n`;
                resultado += `   • Unidades: ${unidadesArray.join(', ')}\n`;
                
                // Mostrar detalle de turnos más recientes
                const turnosRecientes = detalles.turnos.slice(-3);
                resultado += `   • Últimos turnos:\n`;
                turnosRecientes.forEach(turno => {
                    const horaSalida = turno.tipo === 'T2' && turno.salida.split(':')[0] < 12 
                        ? `${turno.salida} PM` 
                        : turno.salida;
                    resultado += `     - ${turno.fecha}: ${horaSalida}-${turno.llegada} (${turno.horas.toFixed(1)}h) U${turno.unidad}\n`;
                });
                resultado += '\n';
            });
            
            return resultado;
        }

        function analizarEstadisticasUnidad(registros, plan) {
            const conteoUnidades = {};
            
            registros.forEach(registro => {
                const unidad = registro.unidad;
                if (!conteoUnidades[unidad]) {
                    conteoUnidades[unidad] = { total: 0, turnos1: 0, turnos2: 0, choferes: new Set() };
                }
                
                if (registro.chofer1Nombre && registro.chofer1Nombre.trim()) {
                    conteoUnidades[unidad].total++;
                    conteoUnidades[unidad].turnos1++;
                    conteoUnidades[unidad].choferes.add(registro.chofer1Nombre);
                }
                
                if (registro.chofer2Nombre && registro.chofer2Nombre.trim()) {
                    conteoUnidades[unidad].total++;
                    conteoUnidades[unidad].turnos2++;
                    conteoUnidades[unidad].choferes.add(registro.chofer2Nombre);
                }
            });
            
            const unidadesSorted = Object.entries(conteoUnidades)
                .sort(([,a], [,b]) => plan.orden === 'asc' ? a.total - b.total : b.total - a.total);
            
            if (unidadesSorted.length === 0) {
                return `No se encontraron unidades activas para ${plan.periodo.descripcion}.`;
            }
            
            let resultado = `ESTADÍSTICAS DE UNIDADES ${plan.periodo.descripcion.toUpperCase()}:\n`;
            unidadesSorted.slice(0, 10).forEach(([unidad, datos], index) => {
                resultado += `${index + 1}. Unidad ${unidad}: ${datos.total} turnos (T1:${datos.turnos1}, T2:${datos.turnos2}) - ${datos.choferes.size} choferes\n`;
            });
            
            return resultado;
        }

        function analizarTurnosPorUnidad(registros, plan) {
            if (registros.length === 0) {
                return `No se encontraron registros para las unidades especificadas.`;
            }
            
            const unidadesAgrupadas = {};
            registros.forEach(registro => {
                if (!unidadesAgrupadas[registro.unidad]) {
                    unidadesAgrupadas[registro.unidad] = [];
                }
                unidadesAgrupadas[registro.unidad].push(registro);
            });
            
            let resultado = `ANÁLISIS POR UNIDAD ${plan.periodo.descripcion.toUpperCase()}:\n`;
            for (const [unidad, regs] of Object.entries(unidadesAgrupadas)) {
                resultado += `\nUnidad ${unidad} (${regs.length} registros):\n`;
                regs.forEach(registro => {
                    resultado += `  ${registro.fecha}: ${formatearTurnosSimple(registro)}\n`;
                });
            }
            
            return resultado;
        }

        function analizarPeriodoComplejo(registros, plan) {
            // Análisis general completo
            let resultado = `ANÁLISIS COMPLETO ${plan.periodo.descripcion.toUpperCase()}:\n`;
            resultado += `Total registros: ${registros.length}\n`;
            
            const unidadesUnicas = new Set(registros.map(r => r.unidad));
            const choferesUnicos = new Set();
            registros.forEach(r => {
                if (r.chofer1Nombre) choferesUnicos.add(r.chofer1Nombre);
                if (r.chofer2Nombre) choferesUnicos.add(r.chofer2Nombre);
            });
            
            resultado += `Unidades activas: ${unidadesUnicas.size}\n`;
            resultado += `Choferes trabajando: ${choferesUnicos.size}\n`;
            
            return resultado;
        }

        // Funciones del Chatbot
        function inicializarChatbot() {
            chatInput = document.getElementById('chat-input');
            chatEnviar = document.getElementById('chat-enviar');
            chatMensajes = document.getElementById('chat-mensajes');
            const toggleConfig = document.getElementById('toggle-config');
            const chatConfig = document.getElementById('chat-config');
            const guardarConfig = document.getElementById('guardar-config');
            
            // Mostrar hora actual en el mensaje de bienvenida
            document.getElementById('bot-time').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Cargar configuración guardada
            cargarConfiguracion();
            
            // Event listeners
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensajeBot();
                }
            });

            // Event listeners para manejar el placeholder
            chatInput.addEventListener('input', function() {
                if (this.textContent.trim() === '') {
                    this.classList.add('placeholder-visible');
                } else {
                    this.classList.remove('placeholder-visible');
                }
            });

            chatInput.addEventListener('focus', function() {
                this.classList.remove('placeholder-visible');
            });

            chatInput.addEventListener('blur', function() {
                if (this.textContent.trim() === '') {
                    this.classList.add('placeholder-visible');
                }
            });
            
            chatEnviar.addEventListener('click', enviarMensajeBot);
            
            toggleConfig.addEventListener('click', function() {
                chatConfig.classList.toggle('hidden');
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
            
            guardarConfig.addEventListener('click', guardarConfiguracion);
            
            // Event listener para limpiar historial
            const limpiarHistorial = document.getElementById('limpiar-historial');
            limpiarHistorial.addEventListener('click', function() {
                if (confirm('¿Estás seguro de que quieres limpiar todo el historial de conversación? Esta acción no se puede deshacer.')) {
                    limpiarHistorialChat();
                }
            });
            
            // Funciones para consultas de base de datos del chatbot
            async function buscarRegistrosPorFecha(fecha) {
                try {
                    const response = await apiCall('registros.php');
                    if (response.success && response.data) {
                        const registros = response.data.filter(registro => 
                            registro.fecha === fecha
                        );
                        return registros;
                    }
                    return [];
                } catch (error) {
                    console.error('Error buscando registros por fecha:', error);
                    return [];
                }
            }
            
            async function buscarRegistrosPorUnidad(numeroUnidad, fechaInicio = null, fechaFin = null) {
                try {
                    const response = await apiCall('registros.php');
                    if (response.success && response.data) {
                        let registros = response.data.filter(registro => 
                            registro.unidad == numeroUnidad
                        );
                        
                        if (fechaInicio && fechaFin) {
                            registros = registros.filter(registro => 
                                registro.fecha >= fechaInicio && registro.fecha <= fechaFin
                            );
                        } else if (fechaInicio) {
                            registros = registros.filter(registro => 
                                registro.fecha >= fechaInicio
                            );
                        }
                        
                        return registros;
                    }
                    return [];
                } catch (error) {
                    console.error('Error buscando registros por unidad:', error);
                    return [];
                }
            }
            
            async function buscarRegistrosPorOperador(nombreOperador, fechaInicio = null, fechaFin = null) {
                try {
                    const response = await apiCall('registros.php');
                    if (response.success && response.data) {
                        let registros = response.data.filter(registro => 
                            (registro.chofer1Nombre && registro.chofer1Nombre.toLowerCase().includes(nombreOperador.toLowerCase())) ||
                            (registro.chofer2Nombre && registro.chofer2Nombre.toLowerCase().includes(nombreOperador.toLowerCase()))
                        );
                        
                        if (fechaInicio && fechaFin) {
                            registros = registros.filter(registro => 
                                registro.fecha >= fechaInicio && registro.fecha <= fechaFin
                            );
                        } else if (fechaInicio) {
                            registros = registros.filter(registro => 
                                registro.fecha >= fechaInicio
                            );
                        }
                        
                        return registros;
                    }
                    return [];
                } catch (error) {
                    console.error('Error buscando registros por operador:', error);
                    return [];
                }
            }
            
            async function buscarOperadores(filtro = '') {
                try {
                    const response = await apiCall('choferes.php');
                    if (response.success && response.data) {
                        if (filtro) {
                            return response.data.filter(operador => 
                                operador.nombre.toLowerCase().includes(filtro.toLowerCase())
                            );
                        }
                        return response.data;
                    }
                    return [];
                } catch (error) {
                    console.error('Error buscando operadores:', error);
                    return [];
                }
            }
            
            function formatearRegistroParaTexto(registro) {
                const fecha = formatearFecha(registro.fecha);
                let texto = `📅 Registro del ${fecha} - Unidad ${registro.numero_unidad}\n`;
                
                if (registro.operador_t1) {
                    texto += `🌅 Turno 1 (6:00-18:00): ${registro.operador_t1}\n`;
                    if (registro.hora_salida_t1 && registro.hora_llegada_t1) {
                        texto += `   ⏰ Salida: ${registro.hora_salida_t1} - Llegada: ${registro.hora_llegada_t1}\n`;
                        texto += `   ⌛ Horas trabajadas: ${registro.horas_t1 || 'No calculado'}\n`;
                    }
                }
                
                if (registro.operador_t2) {
                    texto += `🌙 Turno 2 (18:00-6:00): ${registro.operador_t2}\n`;
                    if (registro.hora_salida_t2 && registro.hora_llegada_t2) {
                        texto += `   ⏰ Salida: ${registro.hora_salida_t2} - Llegada: ${registro.hora_llegada_t2}\n`;
                        texto += `   ⌛ Horas trabajadas: ${registro.horas_t2 || 'No calculado'}\n`;
                    }
                }
                
                const totalTurnos = (registro.operador_t1 ? 1 : 0) + (registro.operador_t2 ? 1 : 0);
                const totalHoras = parseFloat(registro.horas_t1 || 0) + parseFloat(registro.horas_t2 || 0);
                
                texto += `📊 Total turnos: ${totalTurnos} | Total horas: ${totalHoras.toFixed(1)}h\n`;
                
                // Estado del registro
                const estado = (registro.operador_t1 && registro.operador_t2) ? 'Completo' : 
                              (registro.operador_t1 || registro.operador_t2) ? 'Incompleto' : 'Sin registro';
                texto += `🔰 Estado: ${estado}\n`;
                
                return texto;
            }
            
            // Función para formatear turnos de manera simple e informal
            function formatearTurnosSimple(registro) {
                let texto = '';
                
                // Turno 1 (mañana) - usar chofer1Nombre
                const tieneChofer1 = registro.chofer1Nombre && registro.chofer1Nombre.trim() !== '';
                const tieneChofer2 = registro.chofer2Nombre && registro.chofer2Nombre.trim() !== '';
                
                if (tieneChofer1) {
                    let horario1 = '';
                    if (registro.salida1 && registro.llegada1) {
                        horario1 = ` de ${registro.salida1} a ${registro.llegada1}`;
                    } else if (registro.salida1) {
                        horario1 = ` desde las ${registro.salida1}`;
                    } else if (registro.llegada1) {
                        horario1 = ` hasta las ${registro.llegada1}`;
                    } else {
                        horario1 = ' (turno mañana)';
                    }
                    
                    texto += `${registro.chofer1Nombre}${horario1}`;
                    if (tieneChofer2) {
                        texto += ', ';
                    }
                }
                
                // Turno 2 (noche) - usar chofer2Nombre
                if (tieneChofer2) {
                    let horario2 = '';
                    if (registro.salida2 && registro.llegada2) {
                        horario2 = ` de ${registro.salida2} a ${registro.llegada2}`;
                    } else if (registro.salida2) {
                        horario2 = ` desde las ${registro.salida2}`;
                    } else if (registro.llegada2) {
                        horario2 = ` hasta las ${registro.llegada2}`;
                    } else {
                        horario2 = ' (turno noche)';
                    }
                    
                    texto += `${registro.chofer2Nombre}${horario2}`;
                }
                
                // Si no hay ningún turno
                if (!tieneChofer1 && !tieneChofer2) {
                    texto = 'No trabajó nadie ese día';
                }
                
                return texto;
            }
            
            // Función para que el LLM analice la consulta y genere un plan de búsqueda
            async function analizarConsultaConIA(mensaje) {
                try {
                    const apiKey = localStorage.getItem('openai_api_key');
                    if (!apiKey) {
                        throw new Error('API Key de OpenAI no configurada');
                    }
                    
                    const prompt = `Analiza esta consulta sobre turnos de mototaxis y genera un plan de búsqueda JSON:

CONSULTA DEL USUARIO: "${mensaje}"

INFORMACIÓN DEL SISTEMA:
- 200 unidades numeradas del 1 al 200
- Base de datos con registros que incluyen: fecha, unidad, chofer1Nombre, chofer2Nombre, salida1, llegada1, salida2, llegada2
- Fecha actual: ${getFechaLocalISO()}
- Modelo de IA: GPT-5 Nano

TIPOS DE ANÁLISIS POSIBLES:
1. "turnos_por_fecha" - Mostrar turnos de una fecha específica
2. "turnos_por_unidad" - Mostrar turnos de una unidad específica
3. "estadisticas_chofer" - Analizar qué chofer trabajó más
4. "estadisticas_unidad" - Analizar qué unidades trabajaron más
5. "primer_turno_dia" - Encontrar quién empezó primero un día
6. "analisis_periodo" - Análisis complejo de un período

Responde SOLO con un JSON válido con esta estructura:
{
  "tipo_analisis": "uno de los tipos de arriba",
  "periodo": {
    "fecha_inicio": "YYYY-MM-DD o null",
    "fecha_fin": "YYYY-MM-DD o null",
    "descripcion": "descripción del período"
  },
  "filtros": {
    "unidades": [números de unidades específicas o null],
    "choferes": ["nombres específicos o null"]
  },
  "objetivo": "descripción clara de qué buscar",
  "orden": "asc o desc para ordenamiento"
}`;

                    // Intentar usar proxy seguro primero
                    try {
                        console.log('🔐 Análisis IA: Usando proxy seguro...');
                        const proxyResponse = await fetch('api/openai-proxy.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'gpt-5-nano',
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.1,
                                max_tokens: 500
                            })
                        });

                        if (proxyResponse.ok) {
                            const data = await proxyResponse.json();
                            const planTexto = data.choices[0].message.content.trim();
                            
                            // Limpiar el texto para extraer solo el JSON
                            const jsonMatch = planTexto.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const plan = JSON.parse(jsonMatch[0]);
                                console.log('📋 Plan de consulta generado por IA (proxy):', plan);
                                return plan;
                            }
                        } else {
                            console.log('❌ Proxy falló para análisis IA');
                        }
                    } catch (proxyError) {
                        console.log('⚠️ Proxy no disponible para análisis IA');
                    }

                    // Fallback a API directa
                    const userApiKey = localStorage.getItem('openai_api_key');
                    if (!userApiKey) {
                        throw new Error('API Key de OpenAI no configurada y proxy no disponible');
                    }

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userApiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-5-nano',
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.1,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    const planTexto = data.choices[0].message.content.trim();
                    
                    // Limpiar el texto para extraer solo el JSON
                    const jsonMatch = planTexto.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const plan = JSON.parse(jsonMatch[0]);
                        console.log('📋 Plan de consulta generado por IA:', plan);
                        return plan;
                    } else {
                        throw new Error('No se pudo extraer JSON válido de la respuesta');
                    }
                    
                } catch (error) {
                    console.error('Error analizando consulta con IA:', error);
                    // Fallback al análisis manual básico
                    return analizarConsultaManual(mensaje);
                }
            }
            
            // Función de fallback para análisis manual básico
            function analizarConsultaManual(mensaje) {
                const mensajeLower = mensaje.toLowerCase();
                
                // Análisis básico de fechas
                let fechaInicio = null;
                let fechaFin = null;
                
                if (mensajeLower.includes('hoy')) {
                    fechaInicio = fechaFin = getFechaLocalISO();
                } else if (mensajeLower.includes('ayer')) {
                    const ayer = new Date();
                    ayer.setDate(ayer.getDate() - 1);
                    fechaInicio = fechaFin = ayer.toISOString().split('T')[0];
                }
                
                // Detectar números de unidad
                const unidadPattern = /unidad\s*(\d+)/gi;
                const unidadMatches = mensaje.match(unidadPattern);
                let unidades = null;
                if (unidadMatches) {
                    unidades = unidadMatches.map(match => {
                        const numero = match.match(/(\d+)/);
                        return numero ? parseInt(numero[1]) : null;
                    }).filter(num => num !== null && num >= 1 && num <= 200);
                }
                
                return {
                    tipo_analisis: 'turnos_por_fecha',
                    periodo: {
                        fecha_inicio: fechaInicio,
                        fecha_fin: fechaFin,
                        descripcion: 'Consulta básica'
                    },
                    filtros: {
                        unidades: unidades,
                        choferes: null
                    },
                    objetivo: 'Mostrar turnos',
                    orden: 'asc'
                };
            }
            
            // Función para ejecutar el plan de consulta generado por la IA
            async function ejecutarPlanConsulta(plan) {
                try {
                    console.log('🎯 Ejecutando plan:', plan);
                    
                    const response = await apiCall('registros.php');
                    if (!response.success || !response.data) {
                        return 'Error al consultar la base de datos.';
                    }
                    
                    let registros = response.data;
                    
                    // Aplicar filtros de fecha
                    if (plan.periodo.fecha_inicio && plan.periodo.fecha_fin) {
                        registros = registros.filter(registro => 
                            registro.fecha >= plan.periodo.fecha_inicio && 
                            registro.fecha <= plan.periodo.fecha_fin
                        );
                    } else if (plan.periodo.fecha_inicio) {
                        registros = registros.filter(registro => 
                            registro.fecha >= plan.periodo.fecha_inicio
                        );
                    } else if (plan.periodo.fecha_fin) {
                        registros = registros.filter(registro => 
                            registro.fecha <= plan.periodo.fecha_fin
                        );
                    }
                    
                    // Aplicar filtros de unidades
                    if (plan.filtros.unidades && plan.filtros.unidades.length > 0) {
                        registros = registros.filter(registro => 
                            plan.filtros.unidades.includes(registro.unidad)
                        );
                    }
                    
                    // Aplicar filtros de choferes
                    if (plan.filtros.choferes && plan.filtros.choferes.length > 0) {
                        registros = registros.filter(registro => 
                            plan.filtros.choferes.some(chofer => 
                                (registro.chofer1Nombre && registro.chofer1Nombre.toLowerCase().includes(chofer.toLowerCase())) ||
                                (registro.chofer2Nombre && registro.chofer2Nombre.toLowerCase().includes(chofer.toLowerCase()))
                            )
                        );
                    }
                    
                    console.log(`📊 Registros filtrados: ${registros.length}`);
                    
                    // Ejecutar análisis según el tipo
                    switch (plan.tipo_analisis) {
                        case 'turnos_por_fecha':
                            return analizarTurnosPorFecha(registros, plan);
                            
                        case 'turnos_por_unidad':
                            return analizarTurnosPorUnidad(registros, plan);
                            
                        case 'estadisticas_chofer':
                            return analizarEstadisticasChofer(registros, plan);
                            
                        case 'estadisticas_unidad':
                            return analizarEstadisticasUnidad(registros, plan);
                            
                        case 'primer_turno_dia':
                            return analizarPrimerTurno(registros, plan);
                            
                        case 'analisis_periodo':
                            return analizarPeriodoComplejo(registros, plan);
                            
                        default:
                            return analizarTurnosPorFecha(registros, plan);
                    }
                    
                } catch (error) {
                    console.error('Error ejecutando plan:', error);
                    return 'Error al procesar la consulta.';
                }
            }
            
            // Funciones de análisis específicas
            function analizarTurnosPorFecha(registros, plan) {
                if (registros.length === 0) {
                    return `No se encontraron registros para ${plan.periodo.descripcion}.`;
                }
                
                let resultado = `TURNOS ${plan.periodo.descripcion.toUpperCase()}:\n`;
                registros.forEach(registro => {
                    const turnoTexto = formatearTurnosSimple(registro);
                    resultado += `Unidad ${registro.unidad}: ${turnoTexto}\n`;
                });
                
                return resultado;
            }
            
            function analizarTurnosPorUnidad(registros, plan) {
                if (registros.length === 0) {
                    return `No se encontraron registros para las unidades especificadas.`;
                }
                
                const unidadesAgrupadas = {};
                registros.forEach(registro => {
                    if (!unidadesAgrupadas[registro.unidad]) {
                        unidadesAgrupadas[registro.unidad] = [];
                    }
                    unidadesAgrupadas[registro.unidad].push(registro);
                });
                
                let resultado = `ANÁLISIS POR UNIDAD ${plan.periodo.descripcion.toUpperCase()}:\n`;
                for (const [unidad, regs] of Object.entries(unidadesAgrupadas)) {
                    resultado += `\nUnidad ${unidad} (${regs.length} registros):\n`;
                    regs.forEach(registro => {
                        resultado += `  ${registro.fecha}: ${formatearTurnosSimple(registro)}\n`;
                    });
                }
                
                return resultado;
            }
            
            function analizarEstadisticasChofer(registros, plan) {
                const conteoChoferes = {};
                const detallesChoferes = {};
                
                registros.forEach(registro => {
                    // Chofer 1
                    if (registro.chofer1Nombre && registro.chofer1Nombre.trim()) {
                        const nombre = registro.chofer1Nombre;
                        conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                        
                        if (!detallesChoferes[nombre]) {
                            detallesChoferes[nombre] = { unidades: new Set(), fechas: new Set() };
                        }
                        detallesChoferes[nombre].unidades.add(registro.unidad);
                        detallesChoferes[nombre].fechas.add(registro.fecha);
                    }
                    
                    // Chofer 2
                    if (registro.chofer2Nombre && registro.chofer2Nombre.trim()) {
                        const nombre = registro.chofer2Nombre;
                        conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                        
                        if (!detallesChoferes[nombre]) {
                            detallesChoferes[nombre] = { unidades: new Set(), fechas: new Set() };
                        }
                        detallesChoferes[nombre].unidades.add(registro.unidad);
                        detallesChoferes[nombre].fechas.add(registro.fecha);
                    }
                });
                
                const choferesSorted = Object.entries(conteoChoferes)
                    .sort(([,a], [,b]) => plan.orden === 'asc' ? a - b : b - a);
                
                if (choferesSorted.length === 0) {
                    return `No se encontraron choferes para ${plan.periodo.descripcion}.`;
                }
                
                let resultado = `ESTADÍSTICAS DE CHOFERES ${plan.periodo.descripcion.toUpperCase()}:\n`;
                choferesSorted.slice(0, 5).forEach(([nombre, turnos], index) => {
                    const detalles = detallesChoferes[nombre];
                    const unidadesArray = Array.from(detalles.unidades).sort((a, b) => a - b);
                    const diasTrabajados = detalles.fechas.size;
                    resultado += `${index + 1}. ${nombre}: ${turnos} turnos en ${diasTrabajados} días (Unidades: ${unidadesArray.join(', ')})\n`;
                });
                
                return resultado;
            }
            
            function analizarEstadisticasUnidad(registros, plan) {
                const conteoUnidades = {};
                
                registros.forEach(registro => {
                    const unidad = registro.unidad;
                    if (!conteoUnidades[unidad]) {
                        conteoUnidades[unidad] = { total: 0, turnos1: 0, turnos2: 0, choferes: new Set() };
                    }
                    
                    if (registro.chofer1Nombre && registro.chofer1Nombre.trim()) {
                        conteoUnidades[unidad].total++;
                        conteoUnidades[unidad].turnos1++;
                        conteoUnidades[unidad].choferes.add(registro.chofer1Nombre);
                    }
                    
                    if (registro.chofer2Nombre && registro.chofer2Nombre.trim()) {
                        conteoUnidades[unidad].total++;
                        conteoUnidades[unidad].turnos2++;
                        conteoUnidades[unidad].choferes.add(registro.chofer2Nombre);
                    }
                });
                
                const unidadesSorted = Object.entries(conteoUnidades)
                    .sort(([,a], [,b]) => plan.orden === 'asc' ? a.total - b.total : b.total - a.total);
                
                if (unidadesSorted.length === 0) {
                    return `No se encontraron unidades activas para ${plan.periodo.descripcion}.`;
                }
                
                let resultado = `ESTADÍSTICAS DE UNIDADES ${plan.periodo.descripcion.toUpperCase()}:\n`;
                unidadesSorted.slice(0, 10).forEach(([unidad, datos], index) => {
                    resultado += `${index + 1}. Unidad ${unidad}: ${datos.total} turnos (T1:${datos.turnos1}, T2:${datos.turnos2}) - ${datos.choferes.size} choferes\n`;
                });
                
                return resultado;
            }
            
            function analizarPeriodoComplejo(registros, plan) {
                // Análisis general completo
                let resultado = `ANÁLISIS COMPLETO ${plan.periodo.descripcion.toUpperCase()}:\n`;
                resultado += `Total registros: ${registros.length}\n`;
                
                const unidadesUnicas = new Set(registros.map(r => r.unidad));
                const choferesUnicos = new Set();
                registros.forEach(r => {
                    if (r.chofer1Nombre) choferesUnicos.add(r.chofer1Nombre);
                    if (r.chofer2Nombre) choferesUnicos.add(r.chofer2Nombre);
                });
                
                resultado += `Unidades activas: ${unidadesUnicas.size}\n`;
                resultado += `Choferes trabajando: ${choferesUnicos.size}\n`;
                
                return resultado;
            }
                const mensajeLower = mensaje.toLowerCase();
                console.log('🔎 Analizando mensaje:', mensaje);
                
                // Detectar fechas relativas comunes
                let fechasEncontradas = [];
                const hoy = new Date();
                
                if (mensajeLower.includes('hoy')) {
                    const fechaHoy = getFechaLocalISO();
                    fechasEncontradas.push(fechaHoy);
                    console.log('📅 Detectado "hoy":', fechaHoy);
                }
                if (mensajeLower.includes('ayer')) {
                    const ayer = new Date();
                    ayer.setDate(ayer.getDate() - 1);
                    const fechaAyer = ayer.toISOString().split('T')[0];
                    fechasEncontradas.push(fechaAyer);
                    console.log('📅 Detectado "ayer":', fechaAyer);
                }
                
                // Detectar rangos de tiempo para análisis
                if (mensajeLower.includes('último mes') || mensajeLower.includes('ultimos 30 dias') || mensajeLower.includes('últimos 30 días')) {
                    const hace30 = new Date();
                    hace30.setDate(hace30.getDate() - 30);
                    const fechaInicio = hace30.toISOString().split('T')[0];
                    const fechaFin = getFechaLocalISO();
                    fechasEncontradas.push(`RANGO:${fechaInicio}:${fechaFin}`);
                    console.log('📅 Detectado "último mes":', fechaInicio, 'a', fechaFin);
                }
                
                if (mensajeLower.includes('última semana') || mensajeLower.includes('ultimos 7 dias') || mensajeLower.includes('últimos 7 días') || 
                    mensajeLower.includes('ultima semana') || mensajeLower.includes('la semana pasada')) {
                    const hace7 = new Date();
                    hace7.setDate(hace7.getDate() - 7);
                    const fechaInicio = hace7.toISOString().split('T')[0];
                    const fechaFin = getFechaLocalISO();
                    fechasEncontradas.push(`RANGO:${fechaInicio}:${fechaFin}`);
                    console.log('📅 Detectado "última semana":', fechaInicio, 'a', fechaFin);
                }
                
                if (mensajeLower.includes('últimas 2 semanas') || mensajeLower.includes('ultimas 2 semanas') || 
                    mensajeLower.includes('últimos 14 días') || mensajeLower.includes('ultimos 14 dias')) {
                    const hace14 = new Date();
                    hace14.setDate(hace14.getDate() - 14);
                    const fechaInicio = hace14.toISOString().split('T')[0];
                    const fechaFin = getFechaLocalISO();
                    fechasEncontradas.push(`RANGO:${fechaInicio}:${fechaFin}`);
                    console.log('📅 Detectado "últimas 2 semanas":', fechaInicio, 'a', fechaFin);
                }
                
                // Detectar "últimos X días" genérico
                const ultimosDiasPattern = /últimos?\s+(\d+)\s+d[ií]as?/gi;
                const ultimosDiasMatch = mensaje.match(ultimosDiasPattern);
                if (ultimosDiasMatch) {
                    const dias = parseInt(ultimosDiasMatch[0].match(/\d+/)[0]);
                    const haceX = new Date();
                    haceX.setDate(haceX.getDate() - dias);
                    const fechaInicio = haceX.toISOString().split('T')[0];
                    const fechaFin = getFechaLocalISO();
                    fechasEncontradas.push(`RANGO:${fechaInicio}:${fechaFin}`);
                    console.log(`📅 Detectado "últimos ${dias} días":`, fechaInicio, 'a', fechaFin);
                }
                
                // Detectar "hace X días"
                const hacePattern = /hace\s+(\d+)\s+d[ií]as?/gi;
                const haceMatch = mensaje.match(hacePattern);
                if (haceMatch) {
                    const dias = parseInt(haceMatch[0].match(/\d+/)[0]);
                    const fecha = new Date();
                    fecha.setDate(fecha.getDate() - dias);
                    const fechaHace = fecha.toISOString().split('T')[0];
                    fechasEncontradas.push(fechaHace);
                    console.log(`📅 Detectado "hace ${dias} días":`, fechaHace);
                }
                
                // Detectar fechas exactas (varios formatos)
                const fechaPatterns = [
                    /(\d{4}-\d{2}-\d{2})/g,           // YYYY-MM-DD
                    /(\d{1,2}\/\d{1,2}\/\d{4})/g,    // DD/MM/YYYY
                    /(\d{1,2}-\d{1,2}-\d{4})/g,      // DD-MM-YYYY
                    /(\d{1,2}\/\d{1,2}\/\d{2})/g,    // DD/MM/YY
                    /(\d{1,2}-\d{1,2}-\d{2})/g       // DD-MM-YY
                ];
                
                fechaPatterns.forEach(pattern => {
                    const matches = mensaje.match(pattern);
                    if (matches) {
                        console.log(`📅 Patrón ${pattern} encontró:`, matches);
                        fechasEncontradas.push(...matches);
                    }
                });
                
                console.log('📋 Fechas detectadas finales:', fechasEncontradas);
                
                // Detectar números de unidad
                const unidadPattern = /unidad\s*(\d+)/gi;
                const unidadMatches = mensaje.match(unidadPattern);
                let unidadesEncontradas = [];
                if (unidadMatches) {
                    unidadesEncontradas = unidadMatches.map(match => {
                        const numero = match.match(/(\d+)/);
                        return numero ? parseInt(numero[1]) : null;
                    }).filter(num => num !== null && num >= 1 && num <= 200);
                }
                
                // Detectar tipo de consulta
                let tipoConsulta = 'turnos';
                if (mensajeLower.includes('más ha trabajado') || mensajeLower.includes('mas ha trabajado') || 
                    mensajeLower.includes('quien trabajo más') || mensajeLower.includes('quien trabajo mas')) {
                    tipoConsulta = 'estadisticas_chofer';
                    console.log('🔍 Detectada consulta estadística de chofer');
                }
                
                return {
                    fechas: fechasEncontradas,
                    unidades: unidadesEncontradas,
                    tipoConsulta: tipoConsulta
                };
            }
            
            // Función para determinar si una consulta requiere acceso a la base de datos
            async function requiereBaseDatos(mensaje) {
                try {
                    // Obtener contexto de los últimos 4 mensajes para entender la conversación
                    const contextoPrevio = historialChatbot.slice(-4).map(msg => 
                        `${msg.role === 'user' ? 'Usuario' : 'Bot'}: ${msg.content}`
                    ).join('\n');

                    const prompt = `¡Órale! Analiza esta pregunta considerando el contexto previo y dime si necesito checar la base de datos de mototaxis.

CONTEXTO PREVIO:
${contextoPrevio}

PREGUNTA ACTUAL: "${mensaje}"

Responde SOLO "SI" o "NO":

- "SI" si pregunta sobre:
  * Turnos, horarios, fechas específicas o períodos
  * Estadísticas de choferes, quién trabajó más/menos
  * Info de unidades específicas o registros
  * Continuación de consulta previa sobre datos (ej: "y en septiembre?" después de preguntar por agosto)

- "NO" si es:
  * Saludo casual (hola, qué onda, cómo estás)
  * Pregunta personal (quién eres, qué haces)
  * Plática general que no necesita datos

Respuesta:`;

                    const respuesta = await obtenerRespuestaOpenAI(prompt);
                    const decision = respuesta.trim().toUpperCase();
                    
                    console.log('🤖 IA decidió sobre consulta DB:', decision);
                    return decision === 'SI';
                    
                } catch (error) {
                    console.error('Error analizando consulta:', error);
                    // En caso de error, asumir que SÍ necesita DB por seguridad
                    return true;
                }
            }

            async function procesarConsultaBaseDatos(mensaje) {
                console.log('🔍 Procesando consulta con IA:', mensaje);
                
                try {
                    // Obtener contexto de los últimos mensajes para entender la conversación
                    const contextoPrevio = historialChatbot.slice(-6).map(msg => 
                        `${msg.role === 'user' ? 'Usuario' : 'Bot'}: ${msg.content.substring(0, 200)}`
                    ).join('\n');

                    // Crear mensaje con contexto
                    const mensajeConContexto = contextoPrevio 
                        ? `CONTEXTO PREVIO:\n${contextoPrevio}\n\nCONSULTA ACTUAL: ${mensaje}`
                        : mensaje;

                    // Usar IA para analizar la consulta y generar plan
                    const plan = await analizarConsultaConIA(mensajeConContexto);
                    
                    if (plan) {
                        // Ejecutar el plan generado por la IA
                        const resultado = await ejecutarPlanConsulta(plan);
                        return resultado;
                    } else {
                        return 'No pude entender la consulta. ¿Puedes ser más específico?';
                    }
                    
                } catch (error) {
                    console.error('Error procesando consulta con IA:', error);
                    return 'Error al procesar la consulta.';
                }
            }
            
            // Función para analizar qué chofer trabajó más en un rango de fechas
            async function analizarChoferMasTrabajador(fechaInicio, fechaFin) {
                try {
                    console.log(`📊 Analizando choferes desde ${fechaInicio} hasta ${fechaFin}`);
                    
                    const response = await apiCall('registros.php');
                    if (!response.success || !response.data) {
                        return 'Error al consultar la base de datos.';
                    }
                    
                    // Filtrar registros en el rango de fechas
                    const registrosEnRango = response.data.filter(registro => 
                        registro.fecha >= fechaInicio && registro.fecha <= fechaFin
                    );
                    
                    console.log(`📋 Registros en rango encontrados: ${registrosEnRango.length}`);
                    
                    // Contar turnos por chofer
                    const conteoChoferes = {};
                    const detallesChoferes = {};
                    
                    registrosEnRango.forEach(registro => {
                        // Chofer 1
                        if (registro.chofer1Nombre && registro.chofer1Nombre.trim()) {
                            const nombre = registro.chofer1Nombre;
                            conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                            
                            if (!detallesChoferes[nombre]) {
                                detallesChoferes[nombre] = { unidades: new Set(), fechas: new Set() };
                            }
                            detallesChoferes[nombre].unidades.add(registro.unidad);
                            detallesChoferes[nombre].fechas.add(registro.fecha);
                        }
                        
                        // Chofer 2
                        if (registro.chofer2Nombre && registro.chofer2Nombre.trim()) {
                            const nombre = registro.chofer2Nombre;
                            conteoChoferes[nombre] = (conteoChoferes[nombre] || 0) + 1;
                            
                            if (!detallesChoferes[nombre]) {
                                detallesChoferes[nombre] = { unidades: new Set(), fechas: new Set() };
                            }
                            detallesChoferes[nombre].unidades.add(registro.unidad);
                            detallesChoferes[nombre].fechas.add(registro.fecha);
                        }
                    });
                    
                    // Encontrar el chofer con más turnos
                    let choferGanador = null;
                    let maxTurnos = 0;
                    
                    for (const [nombre, turnos] of Object.entries(conteoChoferes)) {
                        if (turnos > maxTurnos) {
                            maxTurnos = turnos;
                            choferGanador = nombre;
                        }
                    }
                    
                    if (choferGanador) {
                        const detalles = detallesChoferes[choferGanador];
                        const unidadesArray = Array.from(detalles.unidades).sort((a, b) => a - b);
                        const diasTrabajados = detalles.fechas.size;
                        
                        // Calcular período más amigable
                        const fechaInicioObj = new Date(fechaInicio);
                        const fechaFinObj = new Date(fechaFin);
                        const diffTime = Math.abs(fechaFinObj - fechaInicioObj);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        let periodo = '';
                        if (diffDays <= 7) {
                            periodo = `última semana (${diffDays} días)`;
                        } else if (diffDays <= 14) {
                            periodo = `últimas 2 semanas (${diffDays} días)`;
                        } else if (diffDays <= 30) {
                            periodo = `último mes (${diffDays} días)`;
                        } else {
                            periodo = `últimos ${diffDays} días`;
                        }
                        
                        let resultado = `CHOFER QUE MÁS TRABAJÓ en la ${periodo}:\n`;
                        resultado += `🏆 ${choferGanador}: ${maxTurnos} turnos en ${diasTrabajados} días\n`;
                        resultado += `🚗 Unidades: ${unidadesArray.join(', ')}\n`;
                        
                        // Top 3 choferes
                        const top3 = Object.entries(conteoChoferes)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 3);
                        
                        resultado += `\n📊 TOP 3:\n`;
                        top3.forEach(([nombre, turnos], index) => {
                            const dias = detallesChoferes[nombre].fechas.size;
                            resultado += `${index + 1}. ${nombre}: ${turnos} turnos (${dias} días)\n`;
                        });
                        
                        return resultado;
                    } else {
                        return `No se encontraron choferes trabajando entre ${fechaInicio} y ${fechaFin}.`;
                    }
                    
                } catch (error) {
                    console.error('Error analizando chofer más trabajador:', error);
                    return 'Error al procesar estadísticas de choferes.';
                }
            }
            
            function normalizarFecha(fecha) {
                // Convertir diferentes formatos de fecha a YYYY-MM-DD
                if (fecha.includes('/')) {
                    const partes = fecha.split('/');
                    if (partes.length === 3) {
                        let dia = partes[0].padStart(2, '0');
                        let mes = partes[1].padStart(2, '0');
                        let año = partes[2];
                        
                        // Manejar años de 2 dígitos (asumiendo 20XX para 00-99)
                        if (año.length === 2) {
                            año = '20' + año;
                        }
                        
                        return `${año}-${mes}-${dia}`;
                    }
                }
                if (fecha.includes('-')) {
                    const partes = fecha.split('-');
                    if (partes.length === 3) {
                        let año = partes[0];
                        let mes = partes[1];
                        let dia = partes[2];
                        
                        // Si el primer componente es corto, podría ser DD-MM-YY
                        if (año.length === 2 && dia.length === 2) {
                            // DD-MM-YY -> intercambiar
                            [dia, mes, año] = [año, mes, dia];
                            año = '20' + año;
                        }
                        
                        return `${año}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                    }
                }
                return fecha;
            }
            
            async function enviarMensajeBot() {
                const mensaje = chatInput.textContent.trim();
                if (mensaje === '') return;
                
                // Deshabilitar input mientras se procesa
                chatInput.contentEditable = false;
                chatEnviar.disabled = true;
                chatEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                
                // Agregar mensaje del usuario
                agregarMensaje('usuario', mensaje);
                
                // Guardar mensaje del usuario en el historial
                historialChatbot.push({
                    role: 'user',
                    content: mensaje
                });
                
                // Limpiar input
                chatInput.textContent = '';
                chatInput.classList.add('placeholder-visible');
                
                let respuestaFinal = '';
                
                try {
                    console.log('Enviando mensaje:', mensaje);
                    
                    // 🤖 Usar IA para determinar si necesita consultar la base de datos
                    console.log('🤖 Analizando si requiere consulta a DB...');
                    chatEnviar.innerHTML = '<i class="fas fa-brain"></i> Analizando consulta...';
                    
                    const necesitaDB = await requiereBaseDatos(mensaje);
                    
                    let respuestaFinal = '';
                    
                    if (necesitaDB) {
                        // Consulta requiere datos de la base de datos
                        console.log('� IA determinó que requiere consulta DB - Buscando datos...');
                        chatEnviar.innerHTML = '<i class="fas fa-database"></i> Consultando turnos...';
                        
                        const datosBaseDatos = await procesarConsultaBaseDatos(mensaje);
                        
                        if (datosBaseDatos && datosBaseDatos.trim()) {
                            // Si encontramos datos de turnos, combinar con respuesta de IA
                            const mensajeConDatos = `${mensaje}

DATOS QUE ENCONTRÉ EN EL SISTEMA:
${datosBaseDatos}

Respóndeme al chile y cortito basándote en estos datos. Háblame como compa mexicano, nada formal.`;

                            chatEnviar.innerHTML = '<i class="fas fa-robot"></i> Analizando turnos...';
                            const respuestaIA = await obtenerRespuestaOpenAI(mensajeConDatos);
                            respuestaFinal = respuestaIA;
                        } else {
                            // No encontramos datos, responder sobre consultas de turnos únicamente
                            console.log('📝 No se encontraron datos, respondiendo sobre turnos...');
                            chatEnviar.innerHTML = '<i class="fas fa-robot"></i> Respondiendo...';
                            const respuestaIA = await obtenerRespuestaOpenAI(mensaje);
                            respuestaFinal = respuestaIA;
                        }
                    } else {
                        // Pregunta general - responder directamente sin analizar DB
                        console.log('💬 IA determinó que NO requiere DB - Respondiendo directamente');
                        chatEnviar.innerHTML = '<i class="fas fa-robot"></i> Respondiendo...';
                        respuestaFinal = await obtenerRespuestaOpenAI(mensaje);
                    }
                    
                    console.log('Respuesta final:', respuestaFinal);
                    agregarMensaje('bot', respuestaFinal);
                    
                    // Guardar respuesta del bot en el historial
                    historialChatbot.push({
                        role: 'assistant',
                        content: respuestaFinal
                    });
                    
                    // Mantener solo los últimos 20 mensajes (10 intercambios)
                    if (historialChatbot.length > 20) {
                        historialChatbot = historialChatbot.slice(-20);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    const mensajeError = 'Lo siento, ha ocurrido un error. Por favor verifica tu configuración de API o la conexión a la base de datos.';
                    agregarMensaje('bot', mensajeError, true);
                    
                    // Guardar respuesta de error en el historial
                    historialChatbot.push({
                        role: 'assistant',
                        content: mensajeError
                    });
                }
                
                // Rehabilitar input
                chatInput.contentEditable = true;
                chatEnviar.disabled = false;
                chatEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
                chatInput.focus();
            }
            
            function agregarMensaje(tipo, texto, esError = false) {
                console.log('Agregando mensaje:', tipo, texto);
                const now = new Date();
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const mensajeDiv = document.createElement('div');
                mensajeDiv.className = 'flex items-start gap-3 mb-4';
                
                if (tipo === 'usuario') {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm';
                    avatarDiv.textContent = '👤';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex-1';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'flex items-center gap-2 mb-1';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-medium text-sm text-green-600';
                    nameSpan.textContent = 'Tú';
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-xs text-gray-500';
                    timeSpan.textContent = timeString;
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-gray-800';
                    messageDiv.textContent = texto;
                    
                    headerDiv.appendChild(nameSpan);
                    headerDiv.appendChild(timeSpan);
                    contentDiv.appendChild(headerDiv);
                    contentDiv.appendChild(messageDiv);
                    mensajeDiv.appendChild(avatarDiv);
                    mensajeDiv.appendChild(contentDiv);
                } else {
                    const bgClass = esError ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200';
                    const textClass = esError ? 'text-red-600' : 'text-blue-600';
                    
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm';
                    avatarDiv.textContent = '🤖';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex-1';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'flex items-center gap-2 mb-1';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = `font-medium text-sm ${textClass}`;
                    nameSpan.textContent = 'Asistente Virtual';
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-xs text-gray-500';
                    timeSpan.textContent = timeString;
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `${bgClass} border rounded-lg p-3 text-sm text-gray-800`;
                    
                    // Convertir saltos de línea a <br> y agregar el contenido
                    if (texto.includes('\n')) {
                        const lines = texto.split('\n');
                        lines.forEach((line, index) => {
                            if (index > 0) {
                                messageDiv.appendChild(document.createElement('br'));
                            }
                            const textNode = document.createTextNode(line);
                            messageDiv.appendChild(textNode);
                        });
                    } else {
                        messageDiv.textContent = texto;
                    }
                    
                    headerDiv.appendChild(nameSpan);
                    headerDiv.appendChild(timeSpan);
                    contentDiv.appendChild(headerDiv);
                    contentDiv.appendChild(messageDiv);
                    mensajeDiv.appendChild(avatarDiv);
                    mensajeDiv.appendChild(contentDiv);
                }
                
                chatMensajes.appendChild(mensajeDiv);
                chatMensajes.scrollTop = chatMensajes.scrollHeight;
            }
            
            async function obtenerRespuestaOpenAI(mensaje) {
                const modelo = localStorage.getItem('openai_model') || 'gpt-5-nano';
                
                console.log('Modelo seleccionado:', modelo);
                
                // Configurar mensajes
                const messages = [
                    {
                        role: 'system',
                        content: `¡Órale! Soy tu cuate del sistema de mototaxis. Te ayudo con rollos de turnos y choferes, pero al chile y sin tanto pedo.

🚕 LO QUE SÉ:
- Turnos por unidad y fecha (nada más dime cuál)
- Quién trabajó más o menos (te doy nombres y números)
- Horarios reales de los compas

📱 DATOS DEL JALE:
- 200 unidades (del 1 al 200)
- T1 = turno de día, T2 = turno de noche
- Los horarios cambian según el chofer

🗣️ MI ONDA:
- Te hablo como compa mexicano, nada formal
- Respuestas cortitas y al grano
- Sin tanto rollo, directo al punto
- Si hay datos de la base, te los paso claros
- RECUERDO la conversación previa para dar continuidad

EJEMPLOS:
"Jenny jaló en la 78 de 5:10 a 2:30"
"Esta semana Pedro fue el que más chambió, 8 turnos"
"Ese día la 25 solo trabajó Carlos desde las 6:15"
"Roberto anda rifando con 137 horas, ¡está cabrón!"

IMPORTANTE: Si preguntan algo como "¿y en septiembre?" después de hablar de agosto en cierta unidad, ENTIENDO que siguen preguntando por la MISMA UNIDAD pero en septiembre.

¡Dale, pregúntame lo que necesites!`
                    }
                ];
                
                // Agregar historial de conversación (mantener los últimos 10 mensajes para no sobrecargar)
                const historialReciente = historialChatbot.slice(-10);
                messages.push(...historialReciente);
                
                // Agregar el mensaje actual del usuario
                messages.push({
                    role: 'user',
                    content: mensaje
                });
                
                const requestBody = {
                    model: modelo,
                    messages: messages
                };

                // Agregar parámetros específicos según el modelo
                if (modelo.startsWith('gpt-5') || modelo.includes('o1')) {
                    // Para GPT-5 y modelos o1, sin límite de tokens
                    // No agregar max_completion_tokens para permitir respuestas largas
                } else {
                    // Para modelos anteriores, usar temperature pero sin límite de tokens
                    requestBody.temperature = 0.7;
                    // No agregar max_tokens para permitir respuestas largas
                }
                
                console.log('Request body:', requestBody);
                
                // Intentar usar proxy seguro primero
                try {
                    console.log('🔐 Intentando usar proxy seguro...');
                    const proxyResponse = await fetch('api/openai-proxy.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (proxyResponse.ok) {
                        const data = await proxyResponse.json();
                        console.log('✅ Respuesta desde proxy seguro:', data);
                        
                        if (data.choices && data.choices[0] && data.choices[0].message) {
                            const mensaje = data.choices[0].message;
                            console.log('Mensaje de la API:', mensaje);
                            console.log('Contenido del mensaje:', mensaje.content);
                            console.log('Finish reason:', data.choices[0].finish_reason);
                            return mensaje.content;
                        }
                        throw new Error('Respuesta de API inválida desde proxy');
                    } else {
                        console.log('❌ Proxy falló, intentando API directa...');
                    }
                } catch (proxyError) {
                    console.log('⚠️ Proxy no disponible:', proxyError.message);
                }

                // Fallback a API directa si el proxy no funciona
                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    throw new Error('API Key no configurada y proxy no disponible. Configura tu API Key en Configuración o contacta al administrador para habilitar el proxy seguro.');
                }
                
                console.log('🔑 Usando API directa con key del usuario...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Error de API:', error);
                    throw new Error(error.error?.message || 'Error en la API de OpenAI');
                }
                
                const data = await response.json();
                console.log('Respuesta completa de API:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Respuesta de API inválida');
                }
                
                console.log('Mensaje de la API:', data.choices[0].message);
                console.log('Contenido del mensaje:', data.choices[0].message.content);
                console.log('Finish reason:', data.choices[0].finish_reason);
                
                const content = data.choices[0].message.content;
                const finishReason = data.choices[0].finish_reason;
                
                // Solo verificar que hay contenido, sin restricciones por finish_reason
                if (!content || content.trim() === '') {
                    console.warn('⚠️ El contenido está vacío, revisando respuesta completa...');
                    console.log('Choices[0] completo:', JSON.stringify(data.choices[0], null, 2));
                    return `Lo siento, la respuesta del modelo está vacía. Finish reason: ${finishReason}. Intenta reformular tu pregunta de manera más específica.`;
                }
                
                // Devolver el contenido completo sin importar el finish_reason
                return content;
            }
            
            function cargarConfiguracion() {
                const apiKey = localStorage.getItem('openai_api_key');
                const modelo = localStorage.getItem('openai_model') || 'gpt-5-nano';
                
                if (apiKey) {
                    document.getElementById('openai-api-key').value = apiKey;
                }
                
                // Asegurar que siempre esté configurado GPT-5 Nano
                document.getElementById('openai-model').value = 'gpt-5-nano';
                if (!localStorage.getItem('openai_model')) {
                    localStorage.setItem('openai_model', 'gpt-5-nano');
                }
            }
            
            function guardarConfiguracion() {
                const apiKey = document.getElementById('openai-api-key').value.trim();
                
                if (apiKey) {
                    localStorage.setItem('openai_api_key', apiKey);
                    localStorage.setItem('openai_model', 'gpt-5-nano'); // Siempre GPT-5 Nano
                    
                    // Mostrar confirmación
                    const btn = document.getElementById('guardar-config');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i> Guardado!';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-green-500');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                } else {
                    alert('Por favor ingresa tu API Key de OpenAI');
                }
            }
            
            function limpiarHistorialChat() {
                // Limpiar el historial de conversación
                historialChatbot = [];
                
                // Limpiar visualmente el chat
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                // Agregar mensaje de bienvenida
                agregarMensaje('bot', '¡Hola! Soy tu asistente para consultar turnos y horarios de mototaxis. Mi historial de conversación ha sido limpiado. Pregúntame sobre los turnos de cualquier unidad en fechas específicas. ¿Qué quieres saber?');
                
                console.log('Historial de chat limpiado');
            }

        // Inicializar chatbot cuando se carga la página
        inicializarChatbot();
        
        // Función de prueba temporal para verificar que todo funciona
        window.testearConsultaFecha = async function(fecha) {
            console.log('🧪 Testeando consulta de fecha:', fecha);
            const fechaNormalizada = normalizarFecha ? normalizarFecha(fecha) : fecha;
            console.log('📅 Fecha normalizada:', fechaNormalizada);
            
            try {
                if (typeof buscarRegistrosPorFecha === 'function') {
                    const registros = await buscarRegistrosPorFecha(fechaNormalizada);
                    console.log('📊 Registros encontrados:', registros.length);
                    console.log('📋 Primeros 3 registros:', registros.slice(0, 3));
                    return registros;
                } else {
                    console.error('❌ Función buscarRegistrosPorFecha no disponible');
                }
            } catch (error) {
                console.error('❌ Error en prueba:', error);
            }
        };
        
        // Función para probar normalización de fechas
        window.testearNormalizacionFecha = function(fecha) {
            console.log('🧪 Testeando normalización de fecha:', fecha);
            const resultado = normalizarFecha ? normalizarFecha(fecha) : 'Función no disponible';
            console.log('📅 Resultado:', resultado);
            return resultado;
        };
        
        // Test específico para la fecha del problema
        console.log('🔧 Probando conversión de fecha 06/09/25:');
        if (typeof normalizarFecha === 'function') {
            const fechaConvertida = normalizarFecha('06/09/25');
            console.log('✅ 06/09/25 se convierte a:', fechaConvertida);
        }
        
        // Test específico para consulta de "ayer"
        window.testearConsultaAyer = async function() {
            console.log('🧪 Testeando consulta de "ayer"');
            
            // 1. Verificar qué fecha es "ayer"
            const ayer = new Date();
            ayer.setDate(ayer.getDate() - 1);
            const fechaAyer = ayer.toISOString().split('T')[0];
            console.log('📅 Fecha de ayer calculada:', fechaAyer);
            
            // 2. Buscar registros directamente
            try {
                const registros = await buscarRegistrosPorFecha(fechaAyer);
                console.log('📊 Total registros encontrados para ayer:', registros.length);
                console.log('📋 Primeros 3 registros:', registros.slice(0, 3));
                
                // 3. Probar formateo
                if (registros.length > 0) {
                    const ejemplo = formatearTurnosSimple(registros[0]);
                    console.log('📝 Ejemplo de formateo:', ejemplo);
                }
                
                return registros;
            } catch (error) {
                console.error('❌ Error en prueba:', error);
            }
        };
    </script>
    <script>
        (function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'958018ca9776aec5',t:'MTc1MTMxMjAyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();
    </script>
    <iframe height="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" width="1">
    </iframe>
</body>

</html>